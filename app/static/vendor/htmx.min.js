(() => {
  const getTargets = (root) => Array.from(root.querySelectorAll('[hx-get]'));

  const parseDelay = (trigger) => {
    const match = trigger.match(/delay:(\d+)ms/);
    return match ? Number(match[1]) : 0;
  };

  const buildUrl = (element) => {
    const baseUrl = element.getAttribute('hx-get');
    if (!baseUrl) {
      return null;
    }
    const include = element.getAttribute('hx-include');
    if (include !== 'closest form') {
      return baseUrl;
    }
    const form = element.closest('form');
    if (!form) {
      return baseUrl;
    }
    const params = new URLSearchParams();
    const formData = new FormData(form);
    for (const [key, value] of formData.entries()) {
      if (value !== '') {
        params.append(key, value.toString());
      }
    }
    const query = params.toString();
    if (!query) {
      return baseUrl;
    }
    const separator = baseUrl.includes('?') ? '&' : '?';
    return `${baseUrl}${separator}${query}`;
  };

  const dispatchAfterSwap = (target) => {
    const event = new CustomEvent('htmx:afterSwap', { detail: { target } });
    document.body.dispatchEvent(event);
  };

  const swapTarget = (targetSelector, html) => {
    const target = document.querySelector(targetSelector);
    if (!target) {
      return;
    }
    target.innerHTML = html;
    bindHx(target);
    dispatchAfterSwap(target);
  };

  const requestSwap = async (element) => {
    const targetSelector = element.getAttribute('hx-target');
    if (!targetSelector) {
      return;
    }
    const url = buildUrl(element);
    if (!url) {
      return;
    }
    const response = await fetch(url, {
      headers: {
        'HX-Request': 'true',
      },
    });
    if (!response.ok) {
      return;
    }
    const html = await response.text();
    swapTarget(targetSelector, html);
    if (element.getAttribute('hx-push-url') === 'true') {
      history.pushState({}, '', url);
    }
  };

  const bindHx = (root) => {
    const targets = getTargets(root);
    targets.forEach((element) => {
      if (element.dataset.hxBound === 'true') {
        return;
      }
      element.dataset.hxBound = 'true';
      const trigger = element.getAttribute('hx-trigger') || 'click';
      const delay = parseDelay(trigger);
      let timeoutId = null;

      const schedule = () => {
        if (timeoutId) {
          clearTimeout(timeoutId);
        }
        const run = () => requestSwap(element);
        timeoutId = delay ? setTimeout(run, delay) : run();
      };

      const handleChange = () => {
        schedule();
      };

      const handleKeyup = () => {
        const currentValue = element.value;
        if (trigger.includes('changed')) {
          if (element.dataset.hxLastValue === currentValue) {
            return;
          }
          element.dataset.hxLastValue = currentValue;
        }
        schedule();
      };

      if (trigger.includes('change')) {
        element.addEventListener('change', handleChange);
      }

      if (trigger.includes('keyup')) {
        element.addEventListener('keyup', handleKeyup);
      }

      if (trigger.includes('search')) {
        element.addEventListener('search', handleKeyup);
      }

      if (!trigger.includes('change') && !trigger.includes('keyup') && !trigger.includes('search')) {
        element.addEventListener('click', (event) => {
          event.preventDefault();
          schedule();
        });
      } else if (element.tagName.toLowerCase() === 'a') {
        element.addEventListener('click', (event) => {
          event.preventDefault();
        });
      }
    });
  };

  document.addEventListener('DOMContentLoaded', () => {
    bindHx(document);
  });
})();
