{% extends "base.html" %}

{% block content %}
<section class="page-header">
  <div>
    <p class="eyebrow">Inventory</p>
    <h1>Hosts</h1>
    <p class="subtitle">Track physical hosts and linked OS/BMC addresses.</p>
  </div>
</section>

{% if errors %}
<div class="alert alert-error">
  <ul>{% for error in errors %}<li>{{ error }}</li>{% endfor %}</ul>
</div>
{% endif %}

<section>
  <details class="card compact-card collapsible-card filter-card" id="host-search-card"{% if show_search %} open{% endif %}>
    <summary class="card-header collapsible-summary">
      <div>
        <h2>Search Hosts</h2>
        <p class="subtitle">Filter by host name, vendor, project, notes, or linked IPs.</p>
      </div>
      <span class="collapsible-indicator" aria-hidden="true">‚ñ∏</span>
    </summary>
    <form class="filters-grid" method="get" action="/ui/hosts">
      <label class="field">
        <span>Search</span>
        <input
          class="input"
          type="text"
          name="q"
          value="{{ filters.q }}"
          placeholder="Name, vendor, project, notes, or IP"
        />
      </label>
      <div class="form-actions">
        <button class="btn btn-primary" type="submit">Apply</button>
        <a class="btn btn-secondary" href="/ui/hosts">Clear</a>
      </div>
    </form>
  </details>
</section>

<section>
  <details class="card compact-card collapsible-card host-add-card" id="add-host-card"{% if show_add_host %} open{% endif %}>
    <summary class="card-header collapsible-summary">
      <div>
        <h2>Add Host</h2>
        <p class="subtitle">Create a new host before assigning IP addresses.</p>
      </div>
      <span class="collapsible-indicator" aria-hidden="true">‚ñ∏</span>
    </summary>
    <form class="form-grid form-grid-two" method="post" action="/ui/hosts">
      <label class="field">
        <span>Name</span>
        <input class="input" type="text" name="name" value="{{ form_state.name }}" />
      </label>
      <label class="field">
        <span>Vendor</span>
        <select class="select" name="vendor_id">
          <option value="">UNASSIGNED</option>
          {% for vendor in vendors %}
          <option value="{{ vendor.id }}"{% if form_state.vendor_id == (vendor.id|string) %} selected{% endif %}>{{ vendor.name }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="field field-span">
        <span>Notes</span>
        <textarea class="textarea" name="notes" rows="2">{{ form_state.notes }}</textarea>
      </label>
      <div class="form-actions field-span">
        <button class="btn btn-primary" type="submit">Add Host</button>
      </div>
    </form>
  </details>
</section>

<section class="card table-card">
  <div class="table-wrapper">
    <table class="table">
      <thead>
        <tr>
          <th>Host name</th>
          <th>Vendor</th>
          <th>Project</th>
          <th>OS IPs</th>
          <th>BMC IPs</th>
          <th>Linked IPs</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if hosts %}
        {% for host in hosts %}
        <tr>
          <td><a href="/ui/hosts/{{ host.id }}">{{ host.name }}</a></td>
          <td>{{ host.vendor or "" }}</td>
          <td>
            {% if host.project_count == 0 %}
            <span class="tag tag-warning">Unassigned</span>
            {% elif host.project_count > 1 %}
            <span class="tag tag-warning">Multiple</span>
            {% else %}
            <span class="tag tag-project" style="--project-color: {{ host.project_color or '#94a3b8' }}">
              {{ host.project_name }}
            </span>
            {% endif %}
          </td>
          <td>{{ host.os_ips or "" }}</td>
          <td>{{ host.bmc_ips or "" }}</td>
          <td>{{ host.ip_count }}</td>
          <td class="asset-actions-cell">
            <div class="row-actions-menu" data-row-actions>
              <button
                class="row-actions-trigger"
                type="button"
                aria-label="Open actions for {{ host.name }}"
                aria-expanded="false"
                aria-haspopup="true"
                aria-controls="row-actions-host-{{ host.id }}"
                data-row-actions-toggle
              >
                <span class="row-actions-icon" aria-hidden="true">‚ãÆ</span>
              </button>
              <div
                class="row-actions-panel"
                id="row-actions-host-{{ host.id }}"
                role="menu"
                aria-label="Actions for {{ host.name }}"
                data-row-actions-panel
                hidden
              >
                <button
                  class="row-action-item"
                  type="button"
                  role="menuitem"
                  data-host-edit-toggle="{{ host.id }}"
                >
                  <span aria-hidden="true">‚úèÔ∏è</span>
                  <span>Edit</span>
                </button>
                <a class="row-action-item row-action-item-danger" role="menuitem" href="/ui/hosts/{{ host.id }}/delete">
                  <span aria-hidden="true">üóëÔ∏è</span>
                  <span>Delete</span>
                </a>
              </div>
            </div>
          </td>
        </tr>
        <tr id="host-edit-row-{{ host.id }}" style="display: none;">
          <td colspan="7">
            <form class="form-grid" method="post" action="/ui/hosts/{{ host.id }}/edit">
              <label class="field">
                <span>Name</span>
                <input class="input" type="text" name="name" value="{{ host.name }}" required />
              </label>
              <label class="field">
                <span>Vendor</span>
                <select class="select" name="vendor_id">
                  <option value="">UNASSIGNED</option>
                  {% for vendor in vendors %}
                  <option value="{{ vendor.id }}"{% if host.vendor and vendor.name == host.vendor %} selected{% endif %}>{{ vendor.name }}</option>
                  {% endfor %}
                </select>
              </label>
              <label class="field">
                <span>Notes</span>
                <textarea class="textarea" name="notes" rows="2">{{ host.notes or "" }}</textarea>
              </label>
              <div class="form-actions">
                <button class="btn btn-primary" type="submit">Save</button>
                <button class="btn btn-secondary" type="button" onclick="toggleHostEdit({{ host.id }})">Cancel</button>
              </div>
            </form>
          </td>
        </tr>
        {% endfor %}
        {% else %}
        <tr><td colspan="7" class="empty-state">No hosts found.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</section>

<script>
function toggleHostEdit(hostId) {
  const row = document.getElementById(`host-edit-row-${hostId}`);
  if (!row) return;
  row.style.display = row.style.display === "none" ? "table-row" : "none";
}

(() => {
  const actionMenus = document.querySelectorAll("[data-row-actions]");
  const POSITION_MARGIN = 12;

  const positionMenuPanel = (toggle, panel) => {
    const triggerRect = toggle.getBoundingClientRect();
    panel.style.position = "fixed";
    panel.style.top = "0";
    panel.style.left = "0";
    panel.style.right = "auto";
    panel.style.bottom = "auto";
    panel.style.visibility = "hidden";
    panel.hidden = false;

    const panelRect = panel.getBoundingClientRect();
    let top = triggerRect.bottom + 6;
    let left = triggerRect.right - panelRect.width;

    if (left < POSITION_MARGIN) {
      left = POSITION_MARGIN;
    }

    if (left + panelRect.width > window.innerWidth - POSITION_MARGIN) {
      left = Math.max(POSITION_MARGIN, window.innerWidth - panelRect.width - POSITION_MARGIN);
    }

    if (top + panelRect.height > window.innerHeight - POSITION_MARGIN) {
      top = triggerRect.top - panelRect.height - 6;
    }

    if (top < POSITION_MARGIN) {
      top = POSITION_MARGIN;
    }

    panel.style.top = `${top}px`;
    panel.style.left = `${left}px`;
    panel.style.visibility = "visible";
  };

  const closeAllMenus = () => {
    actionMenus.forEach((menu) => {
      const toggle = menu.querySelector("[data-row-actions-toggle]");
      const panel = menu.querySelector("[data-row-actions-panel]");
      if (toggle && panel) {
        toggle.setAttribute("aria-expanded", "false");
        panel.hidden = true;
        panel.style.visibility = "";
        menu.classList.remove("is-open");
      }
    });
  };

  actionMenus.forEach((menu) => {
    const toggle = menu.querySelector("[data-row-actions-toggle]");
    const panel = menu.querySelector("[data-row-actions-panel]");
    if (!toggle || !panel) {
      return;
    }

    toggle.addEventListener("click", (event) => {
      event.stopPropagation();
      const isOpen = toggle.getAttribute("aria-expanded") === "true";
      closeAllMenus();
      if (!isOpen) {
        toggle.setAttribute("aria-expanded", "true");
        positionMenuPanel(toggle, panel);
        menu.classList.add("is-open");
      }
    });

    panel.addEventListener("click", (event) => {
      event.stopPropagation();
    });
  });

  document.addEventListener("click", () => {
    closeAllMenus();
  });

  document.addEventListener("keydown", (event) => {
    if (event.key === "Escape") {
      closeAllMenus();
    }
  });

  window.addEventListener(
    "scroll",
    () => {
      closeAllMenus();
    },
    true,
  );

  const tableWrapper = document.querySelector(".table-wrapper");
  if (tableWrapper) {
    tableWrapper.addEventListener("scroll", () => {
      closeAllMenus();
    });
  }

  window.addEventListener("resize", () => {
    closeAllMenus();
  });

  const editButtons = document.querySelectorAll("[data-host-edit-toggle]");
  editButtons.forEach((button) => {
    button.addEventListener("click", () => {
      toggleHostEdit(Number(button.dataset.hostEditToggle));
      closeAllMenus();
    });
  });
})();
</script>
{% endblock %}
