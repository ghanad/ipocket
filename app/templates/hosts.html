{% extends "base.html" %}

{% block content %}
<section class="page-header">
  <div>
    <p class="eyebrow">Inventory</p>
    <h1>Hosts</h1>
    <p class="subtitle">Track physical hosts and linked OS/BMC addresses.</p>
  </div>
  <div class="page-header-actions">
    <button class="btn btn-primary" type="button" data-host-add>New Host</button>
  </div>
</section>

{% if errors %}
<div class="alert alert-error">
  <ul>{% for error in errors %}<li>{{ error }}</li>{% endfor %}</ul>
</div>
{% endif %}

<section>
  <details class="card compact-card collapsible-card filter-card" id="host-search-card"{% if show_search %} open{% endif %}>
    <summary class="card-header collapsible-summary">
      <div>
        <h2>Search Hosts</h2>
        <p class="subtitle">Filter by host name, vendor, project, notes, or linked IPs.</p>
      </div>
      <span class="collapsible-indicator" aria-hidden="true">▸</span>
    </summary>
    <form class="filters-grid" method="get" action="/ui/hosts">
      <label class="field">
        <span>Search</span>
        <input
          class="input"
          type="text"
          name="q"
          value="{{ filters.q }}"
          placeholder="Name, vendor, project, notes, or IP"
        />
      </label>
      <div class="form-actions">
        <button class="btn btn-primary" type="submit">Apply</button>
        <a class="btn btn-secondary" href="/ui/hosts">Clear</a>
      </div>
    </form>
  </details>
</section>

<section class="card table-card">
  <div class="table-wrapper">
    <table class="table">
      <thead>
        <tr>
          <th>Host name</th>
          <th>Vendor</th>
          <th>Project</th>
          <th>OS IPs</th>
          <th>BMC IPs</th>
          <th>Linked IPs</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if hosts %}
        {% for host in hosts %}
        <tr>
          <td><a href="/ui/hosts/{{ host.id }}">{{ host.name }}</a></td>
          <td>{{ host.vendor or "" }}</td>
          <td>
            {% if host.project_count == 0 %}
            <span class="tag tag-warning">Unassigned</span>
            {% elif host.project_count > 1 %}
            <span class="tag tag-warning">Multiple</span>
            {% else %}
            <span class="tag tag-project" style="--project-color: {{ host.project_color or '#94a3b8' }}">
              {{ host.project_name }}
            </span>
            {% endif %}
          </td>
          <td>{{ host.os_ips or "" }}</td>
          <td>{{ host.bmc_ips or "" }}</td>
          <td>{{ host.ip_count }}</td>
          <td class="asset-actions-cell">
            {% set vendor_match = namespace(id="") %}
            {% for vendor in vendors %}
            {% if host.vendor and vendor.name == host.vendor %}
            {% set vendor_match.id = vendor.id %}
            {% endif %}
            {% endfor %}
            <div class="table-actions">
              <button
                class="btn btn-secondary btn-small"
                type="button"
                data-host-edit="{{ host.id }}"
                data-host-name="{{ host.name }}"
                data-host-vendor-id="{{ vendor_match.id }}"
                data-host-project-name="{{ host.project_name or '' }}"
                data-host-project-count="{{ host.project_count }}"
                data-host-os-ips="{{ host.os_ips or "" }}"
                data-host-bmc-ips="{{ host.bmc_ips or "" }}"
                data-host-notes="{{ host.notes or "" }}"
                data-host-status="{{ 'Assigned' if host.ip_count > 0 else 'Free' }}"
              >
                Edit
              </button>
              <a class="btn btn-danger btn-small" href="/ui/hosts/{{ host.id }}/delete">Delete</a>
            </div>
          </td>
        </tr>
        {% endfor %}
        {% else %}
        <tr><td colspan="7" class="empty-state">No hosts found.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
  {% if hosts and pagination %}
  <div class="table-footer">
    <div class="table-meta">
      {% if pagination.total %}
      Showing {{ pagination.start_index }}-{{ pagination.end_index }} of {{ pagination.total }}
      {% else %}
      No results to display.
      {% endif %}
    </div>
    <div class="table-footer-controls">
      <div class="table-per-page">
        <form method="get" action="/ui/hosts" class="per-page-form">
          {% if filters.q %}
          <input type="hidden" name="q" value="{{ filters.q }}" />
          {% endif %}
          <label class="field field-inline">
            <span>Rows</span>
            <select
              class="select select-minimal"
              name="per-page"
              onchange="this.form.submit()"
            >
              {% for option in [10, 20, 50, 100] %}
              <option value="{{ option }}"{% if pagination.per_page == option %} selected{% endif %}>{{ option }}</option>
              {% endfor %}
            </select>
          </label>
        </form>
      </div>
      {% if pagination.total_pages > 1 %}
      <nav class="pagination" aria-label="Hosts pagination">
        <a
          class="btn btn-secondary btn-small{% if not pagination.has_prev %} btn-disabled{% endif %}"
          href="/ui/hosts?{{ pagination.base_query }}&page={{ pagination.page - 1 }}"
          {% if not pagination.has_prev %}
          aria-disabled="true"
          tabindex="-1"
          {% endif %}
        >
          Previous
        </a>
        <span class="pagination-status">Page {{ pagination.page }} of {{ pagination.total_pages }}</span>
        <a
          class="btn btn-secondary btn-small{% if not pagination.has_next %} btn-disabled{% endif %}"
          href="/ui/hosts?{{ pagination.base_query }}&page={{ pagination.page + 1 }}"
          {% if not pagination.has_next %}
          aria-disabled="true"
          tabindex="-1"
          {% endif %}
        >
          Next
        </a>
      </nav>
      {% endif %}
    </div>
  </div>
  {% endif %}
</section>

<div class="host-drawer-overlay" data-host-drawer-overlay aria-hidden="true"></div>
<aside class="host-drawer" data-host-drawer role="dialog" aria-modal="true" aria-label="Host drawer">
  <div class="host-drawer-header">
    <div class="host-drawer-header-row">
      <div>
        <h2 class="host-drawer-title" data-host-drawer-title>Edit Host</h2>
        <p class="host-drawer-subtitle" data-host-drawer-subtitle>—</p>
      </div>
      <button class="host-drawer-close" type="button" aria-label="Close drawer" data-host-drawer-close>
        ✕
      </button>
    </div>
    <div class="host-drawer-meta" data-host-drawer-meta>
      <span class="host-drawer-pill" data-host-drawer-project>Project: Unassigned</span>
      <span class="host-drawer-pill host-drawer-pill-success" data-host-drawer-status>Status: Free</span>
    </div>
  </div>
  <div class="host-drawer-body">
    <form class="host-drawer-form" method="post" data-host-edit-form id="host-edit-form">
      <section class="host-drawer-section">
        <h3>Basic</h3>
        <label class="field">
          <span>Name</span>
          <input class="input" type="text" name="name" required data-host-input="name" />
          <span class="host-drawer-error" data-host-error="name" role="alert"></span>
        </label>
        <div class="host-drawer-row host-drawer-row-two">
          <label class="field">
            <span>Vendor</span>
            <select class="select" name="vendor_id" data-host-input="vendor_id">
              <option value="">UNASSIGNED</option>
              {% for vendor in vendors %}
              <option value="{{ vendor.id }}">{{ vendor.name }}</option>
              {% endfor %}
            </select>
          </label>
          <label class="field" data-host-project-field>
            <span>Project</span>
            <select class="select" name="project_id" data-host-input="project_id" data-host-project-select>
              <option value="">Unassigned</option>
              {% for project in projects %}
              <option value="{{ project.id }}" data-project-name="{{ project.name }}">{{ project.name }}</option>
              {% endfor %}
            </select>
          </label>
        </div>
      </section>
      <section class="host-drawer-section">
        <h3>IP Configuration</h3>
        <div class="host-drawer-row host-drawer-row-two">
          <label class="field">
            <span>OS IP</span>
            <input class="input" type="text" name="os_ips" placeholder="e.g. 192.168.10.200" data-host-input="os_ips" />
            <span class="host-drawer-error" data-host-error="os_ips" role="alert"></span>
          </label>
          <label class="field">
            <span>BMC IP (Out-of-band)</span>
            <input class="input" type="text" name="bmc_ips" placeholder="e.g. 192.168.20.10" data-host-input="bmc_ips" />
            <span class="host-drawer-error" data-host-error="bmc_ips" role="alert"></span>
          </label>
        </div>
        <p class="host-drawer-help">Both fields are single-value based on your product assumptions.</p>
      </section>
      <section class="host-drawer-section">
        <h3>Notes</h3>
        <label class="field">
          <span>Notes</span>
          <textarea class="textarea" name="notes" rows="3" data-host-input="notes"></textarea>
        </label>
      </section>
    </form>
  </div>
  <div class="host-drawer-footer">
    <span class="host-drawer-footer-status" data-host-drawer-dirty>No changes</span>
    <div class="host-drawer-footer-actions">
      <button class="btn btn-secondary" type="button" data-host-drawer-cancel>Cancel</button>
      <button class="btn btn-primary" type="submit" form="host-edit-form" data-host-drawer-save disabled>Save changes</button>
    </div>
  </div>
</aside>

<style>
  /* Hosts table: horizontal layout for Edit/Delete buttons */
  .asset-actions-cell {
    width: auto;
    min-width: 140px;
    white-space: nowrap;
  }

  .host-drawer-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.45);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    z-index: 40;
  }

  .host-drawer-overlay.is-open {
    opacity: 1;
    pointer-events: auto;
  }

  .host-drawer {
    position: fixed;
    top: 0;
    right: 0;
    height: 100vh;
    width: min(520px, 92vw);
    background: var(--color-surface);
    border-left: 1px solid var(--color-border);
    box-shadow: 0 18px 32px rgba(15, 23, 42, 0.18);
    transform: translateX(105%);
    transition: transform 0.25s ease;
    display: flex;
    flex-direction: column;
    z-index: 50;
  }

  .host-drawer.is-open {
    transform: translateX(0);
  }

  .host-drawer-header {
    padding: 18px 20px 12px;
    border-bottom: 1px solid var(--color-border);
    background: #fbfdff;
  }

  .host-drawer-header-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 16px;
  }

  .host-drawer-title {
    font-size: 18px;
    margin: 0;
    word-break: break-word;
  }

  .host-drawer-subtitle {
    margin: 4px 0 0;
    font-size: 13px;
    color: var(--color-muted);
    word-break: break-word;
  }

  .host-drawer-meta {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 12px;
  }

  .host-drawer-pill {
    display: inline-flex;
    align-items: center;
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid var(--color-border);
    background: #f8fafc;
    font-size: 12px;
    font-weight: 700;
    color: var(--color-text);
  }

  .host-drawer-pill-success {
    border-color: #86efac;
    background: #dcfce7;
    color: #166534;
  }

  .host-drawer-close {
    border: 1px solid var(--color-border);
    background: #fff;
    border-radius: 10px;
    width: 36px;
    height: 36px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }

  .host-drawer-body {
    padding: 18px 20px 120px;
    overflow-y: auto;
  }

  .host-drawer-form {
    display: grid;
    gap: 16px;
  }

  .host-drawer-section {
    border: 1px solid var(--color-border);
    border-radius: 16px;
    padding: 16px;
    background: #fff;
  }

  .host-drawer-section h3 {
    font-size: 14px;
    margin-bottom: 12px;
  }

  .host-drawer-row {
    display: grid;
    gap: 12px;
  }

  .host-drawer-row-two {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .host-drawer-help {
    margin: 8px 0 0;
    font-size: 12px;
    color: var(--color-muted);
  }

  .host-drawer-footer {
    position: sticky;
    bottom: 0;
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    background: rgba(255, 255, 255, 0.95);
    border-top: 1px solid var(--color-border);
    backdrop-filter: blur(6px);
  }

  .host-drawer-footer-status {
    color: var(--color-muted);
    font-size: 12px;
    font-weight: 600;
  }

  .host-drawer-footer-actions {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .host-drawer-error {
    display: none;
    color: var(--color-danger);
    font-size: 12px;
    font-weight: 600;
    min-height: 16px;
  }

  @media (max-width: 600px) {
    .host-drawer-row-two {
      grid-template-columns: 1fr;
    }

    .host-drawer-footer {
      flex-direction: column;
      align-items: flex-end;
    }
  }

  .table-footer-controls {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .table-per-page {
    display: flex;
    align-items: center;
  }
  .per-page-form {
    margin: 0;
  }
  .per-page-form .field {
    margin: 0;
    flex-direction: row;
    align-items: center;
    gap: 6px;
  }
  .per-page-form .field span {
    font-size: 12px;
    color: var(--color-muted-light, #64748b);
    font-weight: 400;
  }
  .select-minimal {
    appearance: none;
    background: transparent;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    padding: 2px 20px 2px 6px;
    font-size: 12px;
    color: #64748b;
    cursor: pointer;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 4px center;
  }
  .select-minimal:hover {
    border-color: #cbd5e1;
  }
  .select-minimal:focus {
    outline: none;
    border-color: #94a3b8;
  }
</style>

<script>
(() => {
  const overlay = document.querySelector("[data-host-drawer-overlay]");
  const drawer = document.querySelector("[data-host-drawer]");
  const drawerTitle = document.querySelector("[data-host-drawer-title]");
  const drawerSubtitle = document.querySelector("[data-host-drawer-subtitle]");
  const drawerMeta = document.querySelector("[data-host-drawer-meta]");
  const projectField = document.querySelector("[data-host-project-field]");
  const closeButton = document.querySelector("[data-host-drawer-close]");
  const cancelButton = document.querySelector("[data-host-drawer-cancel]");
  const saveButton = document.querySelector("[data-host-drawer-save]");
  const form = document.querySelector("[data-host-edit-form]");
  const projectPill = document.querySelector("[data-host-drawer-project]");
  const statusPill = document.querySelector("[data-host-drawer-status]");
  const projectSelect = document.querySelector("[data-host-project-select]");
  const dirtyStatus = document.querySelector("[data-host-drawer-dirty]");
  const inputs = form ? form.querySelectorAll("[data-host-input]") : [];
  const errorMessages = form ? form.querySelectorAll("[data-host-error]") : [];
  let initialValues = {};
  let isOpen = false;
  let isAddMode = false;

  if (
    !overlay ||
    !drawer ||
    !form ||
    !drawerTitle ||
    !drawerSubtitle ||
    !closeButton ||
    !cancelButton ||
    !saveButton ||
    !projectPill ||
    !statusPill ||
    !projectSelect ||
    !dirtyStatus
  ) {
    return;
  }

  const isValidIPv4 = (value) => {
    if (!value) return true;
    const trimmed = value.trim();
    const regex = /^(25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)){3}$/;
    return regex.test(trimmed);
  };

  const setError = (field, message) => {
    const error = form.querySelector(`[data-host-error="${field}"]`);
    if (!error) return;
    if (message) {
      error.textContent = message;
      error.style.display = "block";
    } else {
      error.textContent = "";
      error.style.display = "none";
    }
  };

  const clearErrors = () => {
    errorMessages.forEach((error) => {
      error.textContent = "";
      error.style.display = "none";
    });
  };

  const normalizeValue = (value) => value.trim();

  const isDirty = () =>
    Array.from(inputs).some((input) => {
      const key = input.dataset.hostInput;
      return normalizeValue(input.value) !== (initialValues[key] || "");
    });

  const validate = () => {
    let valid = true;
    const nameInput = form.querySelector('[data-host-input="name"]');
    const osInput = form.querySelector('[data-host-input="os_ips"]');
    const bmcInput = form.querySelector('[data-host-input="bmc_ips"]');

    if (nameInput && !nameInput.value.trim()) {
      setError("name", "Host name is required.");
      valid = false;
    } else {
      setError("name", "");
    }

    if (osInput && osInput.value.trim() && !isValidIPv4(osInput.value)) {
      setError("os_ips", "Enter a valid IPv4 address.");
      valid = false;
    } else {
      setError("os_ips", "");
    }

    if (bmcInput && bmcInput.value.trim() && !isValidIPv4(bmcInput.value)) {
      setError("bmc_ips", "Enter a valid IPv4 address.");
      valid = false;
    } else {
      setError("bmc_ips", "");
    }

    return valid;
  };

  const updateSaveState = () => {
    const dirty = isDirty();
    const valid = validate();
    saveButton.disabled = !(dirty && valid);
    if (isAddMode) {
      dirtyStatus.textContent = dirty ? "Ready to create" : "Enter details";
    } else {
      dirtyStatus.textContent = dirty ? "Unsaved changes" : "No changes";
    }
  };

  const openDrawerForAdd = () => {
    isAddMode = true;
    clearErrors();
    inputs.forEach((input) => {
      input.value = "";
    });
    form.action = "/ui/hosts";
    drawerTitle.textContent = "Add Host";
    drawerSubtitle.textContent = "Create a new host";
    drawerMeta.style.display = "none";
    if (projectField) {
      projectField.style.display = "none";
    }
    const defaultOption = projectSelect.querySelector('option[value=""]');
    if (defaultOption) {
      defaultOption.textContent = "Unassigned";
    }
    projectSelect.value = "";
    initialValues = {
      name: "",
      vendor_id: "",
      project_id: "",
      os_ips: "",
      bmc_ips: "",
      notes: "",
    };
    updateSaveState();
    saveButton.textContent = "Create Host";
    overlay.classList.add("is-open");
    drawer.classList.add("is-open");
    isOpen = true;
    // Focus the name input
    const nameInput = form.querySelector('[data-host-input="name"]');
    if (nameInput) {
      setTimeout(() => nameInput.focus(), 100);
    }
  };

  const openDrawerForEdit = (hostData) => {
    isAddMode = false;
    clearErrors();
    inputs.forEach((input) => {
      const key = input.dataset.hostInput;
      input.value = hostData[key] || "";
    });
    form.action = `/ui/hosts/${hostData.id}/edit`;
    drawerTitle.textContent = "Edit Host";
    drawerSubtitle.textContent = hostData.name || "—";
    drawerMeta.style.display = "flex";
    if (projectField) {
      projectField.style.display = "";
    }
    projectPill.textContent = `Project: ${hostData.project_label || "Unassigned"}`;
    statusPill.textContent = `Status: ${hostData.status || "Free"}`;
    const defaultOption = projectSelect.querySelector('option[value=""]');
    if (defaultOption) {
      defaultOption.textContent = hostData.project_label || "Unassigned";
    }
    if (hostData.project_label && hostData.project_label !== "Unassigned" && hostData.project_label !== "Multiple") {
      const match = Array.from(projectSelect.options).find(
        (option) => option.dataset.projectName === hostData.project_label,
      );
      projectSelect.value = match ? match.value : "";
    } else {
      projectSelect.value = "";
    }
    initialValues = {
      name: hostData.name || "",
      vendor_id: hostData.vendor_id || "",
      project_id: projectSelect.value || "",
      os_ips: hostData.os_ips || "",
      bmc_ips: hostData.bmc_ips || "",
      notes: hostData.notes || "",
    };
    updateSaveState();
    saveButton.textContent = "Save changes";
    overlay.classList.add("is-open");
    drawer.classList.add("is-open");
    isOpen = true;
  };

  const closeDrawer = () => {
    overlay.classList.remove("is-open");
    drawer.classList.remove("is-open");
    isOpen = false;
    isAddMode = false;
  };

  const confirmClose = () => {
    if (!isDirty()) {
      closeDrawer();
      return;
    }
    if (window.confirm("Discard changes?")) {
      closeDrawer();
    }
  };

  // Add Host button
  document.querySelectorAll("[data-host-add]").forEach((button) => {
    button.addEventListener("click", () => {
      openDrawerForAdd();
    });
  });

  // Edit buttons
  document.querySelectorAll("[data-host-edit]").forEach((button) => {
    button.addEventListener("click", () => {
      const hostData = {
        id: button.dataset.hostEdit,
        name: button.dataset.hostName || "",
        vendor_id: button.dataset.hostVendorId || "",
        project_label: (() => {
          const count = Number.parseInt(button.dataset.hostProjectCount || "0", 10);
          if (Number.isNaN(count) || count === 0) {
            return "Unassigned";
          }
          if (count > 1) {
            return "Multiple";
          }
          return button.dataset.hostProjectName || "Unassigned";
        })(),
        os_ips: button.dataset.hostOsIps || "",
        bmc_ips: button.dataset.hostBmcIps || "",
        notes: button.dataset.hostNotes || "",
        status: button.dataset.hostStatus || "Free",
      };
      openDrawerForEdit(hostData);
    });
  });

  closeButton.addEventListener("click", confirmClose);
  cancelButton.addEventListener("click", confirmClose);
  overlay.addEventListener("click", confirmClose);

  document.addEventListener("keydown", (event) => {
    if (event.key === "Escape" && isOpen) {
      confirmClose();
    }
  });

  inputs.forEach((input) => {
    input.addEventListener("input", () => {
      updateSaveState();
    });
  });

  form.addEventListener("submit", (event) => {
    if (!validate()) {
      event.preventDefault();
      updateSaveState();
    }
  });
})();
</script>
{% endblock %}
