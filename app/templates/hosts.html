{% extends "base.html" %}

{% block content %}
<section class="page-header">
  <div>
    <p class="eyebrow">Inventory</p>
    <h1>Hosts</h1>
    <p class="subtitle">Track physical hosts and linked OS/BMC addresses.</p>
  </div>
  <div class="page-header-actions">
    <button class="btn btn-primary" type="button" data-host-add>New Host</button>
  </div>
</section>

{% if errors %}
<div class="alert alert-error">
  <ul>{% for error in errors %}<li>{{ error }}</li>{% endfor %}</ul>
</div>
{% endif %}

<section>
  <details class="card compact-card collapsible-card filter-card" id="host-search-card"{% if show_search %} open{% endif %}>
    <summary class="card-header collapsible-summary">
      <div>
        <h2>Search Hosts</h2>
        <p class="subtitle">Filter by host name, vendor, project, notes, or linked IPs.</p>
      </div>
      <span class="collapsible-indicator" aria-hidden="true">▸</span>
    </summary>
    <form class="filters-grid" method="get" action="/ui/hosts">
      <label class="field">
        <span>Search</span>
        <input
          class="input"
          type="text"
          name="q"
          value="{{ filters.q }}"
          placeholder="Name, vendor, project, notes, or IP"
        />
      </label>
      <div class="form-actions">
        <button class="btn btn-primary" type="submit">Apply</button>
        <a class="btn btn-secondary" href="/ui/hosts">Clear</a>
      </div>
    </form>
  </details>
</section>

<section class="card table-card">
  <div class="table-wrapper">
    <table class="table">
      <thead>
        <tr>
          <th>Host name</th>
          <th>Vendor</th>
          <th>Project</th>
          <th>OS IPs</th>
          <th>BMC IPs</th>
          <th>Linked IPs</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if hosts %}
        {% for host in hosts %}
        <tr>
          <td><a href="/ui/hosts/{{ host.id }}">{{ host.name }}</a></td>
          <td>{{ host.vendor or "" }}</td>
          <td>
            {% if host.project_count == 0 %}
            <span class="tag tag-warning">Unassigned</span>
            {% elif host.project_count > 1 %}
            <span class="tag tag-warning">Multiple</span>
            {% else %}
            <span class="tag tag-project" style="--project-color: {{ host.project_color or '#94a3b8' }}">
              {{ host.project_name }}
            </span>
            {% endif %}
          </td>
          <td>{{ host.os_ips or "" }}</td>
          <td>{{ host.bmc_ips or "" }}</td>
          <td>{{ host.ip_count }}</td>
          <td class="asset-actions-cell">
            {% set vendor_match = namespace(id="") %}
            {% for vendor in vendors %}
            {% if host.vendor and vendor.name == host.vendor %}
            {% set vendor_match.id = vendor.id %}
            {% endif %}
            {% endfor %}
            <div class="table-actions">
              <button
                class="btn btn-secondary btn-small"
                type="button"
                data-host-edit="{{ host.id }}"
                data-host-name="{{ host.name }}"
                data-host-vendor-id="{{ vendor_match.id }}"
                data-host-project-name="{{ host.project_name or '' }}"
                data-host-project-count="{{ host.project_count }}"
                data-host-os-ips="{{ host.os_ips or "" }}"
                data-host-bmc-ips="{{ host.bmc_ips or "" }}"
                data-host-notes="{{ host.notes or "" }}"
                data-host-status="{{ 'Assigned' if host.ip_count > 0 else 'Free' }}"
              >
                Edit
              </button>
              <button
                class="btn btn-danger btn-small"
                type="button"
                data-host-delete="{{ host.id }}"
                data-host-name="{{ host.name }}"
                data-host-vendor="{{ host.vendor or '' }}"
                data-host-linked-count="{{ host.ip_count }}"
                data-host-project-name="{{ host.project_name or '' }}"
              >
                Delete
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
        {% else %}
        <tr><td colspan="7" class="empty-state">No hosts found.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
  {% if hosts and pagination %}
  <div class="table-footer">
    <div class="table-meta">
      {% if pagination.total %}
      Showing {{ pagination.start_index }}-{{ pagination.end_index }} of {{ pagination.total }}
      {% else %}
      No results to display.
      {% endif %}
    </div>
    <div class="table-footer-controls">
      <div class="table-per-page">
        <form method="get" action="/ui/hosts" class="per-page-form">
          {% if filters.q %}
          <input type="hidden" name="q" value="{{ filters.q }}" />
          {% endif %}
          <label class="field field-inline">
            <span>Rows</span>
            <select
              class="select select-minimal"
              name="per-page"
              onchange="this.form.submit()"
            >
              {% for option in [10, 20, 50, 100] %}
              <option value="{{ option }}"{% if pagination.per_page == option %} selected{% endif %}>{{ option }}</option>
              {% endfor %}
            </select>
          </label>
        </form>
      </div>
      {% if pagination.total_pages > 1 %}
      <nav class="pagination" aria-label="Hosts pagination">
        <a
          class="btn btn-secondary btn-small{% if not pagination.has_prev %} btn-disabled{% endif %}"
          href="/ui/hosts?{{ pagination.base_query }}&page={{ pagination.page - 1 }}"
          {% if not pagination.has_prev %}
          aria-disabled="true"
          tabindex="-1"
          {% endif %}
        >
          Previous
        </a>
        <span class="pagination-status">Page {{ pagination.page }} of {{ pagination.total_pages }}</span>
        <a
          class="btn btn-secondary btn-small{% if not pagination.has_next %} btn-disabled{% endif %}"
          href="/ui/hosts?{{ pagination.base_query }}&page={{ pagination.page + 1 }}"
          {% if not pagination.has_next %}
          aria-disabled="true"
          tabindex="-1"
          {% endif %}
        >
          Next
        </a>
      </nav>
      {% endif %}
    </div>
  </div>
  {% endif %}
</section>

<div class="host-drawer-overlay" data-host-drawer-overlay aria-hidden="true"></div>
<aside class="host-drawer" data-host-drawer role="dialog" aria-modal="true" aria-label="Host drawer">
  <div class="host-drawer-header">
    <div class="host-drawer-header-row">
      <div>
        <h2 class="host-drawer-title" data-host-drawer-title>Edit Host</h2>
        <p class="host-drawer-subtitle" data-host-drawer-subtitle>—</p>
      </div>
      <button class="host-drawer-close" type="button" aria-label="Close drawer" data-host-drawer-close>
        ✕
      </button>
    </div>
    <div class="host-drawer-meta" data-host-drawer-meta>
      <span class="host-drawer-pill" data-host-drawer-project>Project: Unassigned</span>
      <span class="host-drawer-pill host-drawer-pill-success" data-host-drawer-status>Status: Free</span>
    </div>
  </div>
  <div class="host-drawer-body">
    <form class="host-drawer-form" method="post" data-host-edit-form data-host-mode-panel="edit" id="host-edit-form">
      <section class="host-drawer-section">
        <h3>Basic</h3>
        <label class="field">
          <span>Name</span>
          <input class="input" type="text" name="name" required data-host-input="name" />
          <span class="host-drawer-error" data-host-error="name" role="alert"></span>
        </label>
        <div class="host-drawer-row host-drawer-row-two">
          <label class="field">
            <span>Vendor</span>
            <select class="select" name="vendor_id" data-host-input="vendor_id">
              <option value="">UNASSIGNED</option>
              {% for vendor in vendors %}
              <option value="{{ vendor.id }}">{{ vendor.name }}</option>
              {% endfor %}
            </select>
          </label>
          <label class="field" data-host-project-field>
            <span>Project</span>
            <select class="select" name="project_id" data-host-input="project_id" data-host-project-select>
              <option value="">Unassigned</option>
              {% for project in projects %}
              <option value="{{ project.id }}" data-project-name="{{ project.name }}">{{ project.name }}</option>
              {% endfor %}
            </select>
          </label>
        </div>
      </section>
      <section class="host-drawer-section">
        <h3>IP Configuration</h3>
        <div class="host-drawer-row host-drawer-row-two">
          <label class="field">
            <span>OS IP</span>
            <input class="input" type="text" name="os_ips" placeholder="e.g. 192.168.10.200" data-host-input="os_ips" />
            <span class="host-drawer-error" data-host-error="os_ips" role="alert"></span>
          </label>
          <label class="field">
            <span>BMC IP (Out-of-band)</span>
            <input class="input" type="text" name="bmc_ips" placeholder="e.g. 192.168.20.10" data-host-input="bmc_ips" />
            <span class="host-drawer-error" data-host-error="bmc_ips" role="alert"></span>
          </label>
        </div>
        <p class="host-drawer-help">Both fields are single-value based on your product assumptions.</p>
      </section>
      <section class="host-drawer-section">
        <h3>Notes</h3>
        <label class="field">
          <span>Notes</span>
          <textarea class="textarea" name="notes" rows="3" data-host-input="notes"></textarea>
        </label>
      </section>
    </form>

    <form class="host-drawer-form host-drawer-delete-form" method="post" data-host-delete-form data-host-mode-panel="delete" id="host-delete-form" hidden>
      <input type="hidden" name="return_to" value="/ui/hosts" data-host-delete-return-to>
      <section class="host-drawer-section">
        <h3 class="host-drawer-delete-heading">Delete Host?</h3>
        <p class="host-drawer-delete-warning">Permanent and cannot be undone.</p>
        <dl class="host-drawer-delete-details">
          <div><dt>Name</dt><dd class="mono" data-host-delete-name>—</dd></div>
          <div><dt>Vendor</dt><dd data-host-delete-vendor>—</dd></div>
          <div><dt>Project</dt><dd data-host-delete-project>Unassigned</dd></div>
          <div><dt>Linked IPs</dt><dd data-host-delete-linked-count>0</dd></div>
        </dl>
        <label class="field field-inline">
          <input class="checkbox" type="checkbox" name="confirm_delete_ack" data-host-delete-ack>
          <span>I understand this cannot be undone</span>
        </label>
        <label class="field">
          <span>Type the exact host name to confirm</span>
          <input class="input" type="text" name="confirm_name" data-host-delete-confirm-input autocomplete="off" />
        </label>
        <p class="host-drawer-help host-drawer-help-error" data-host-delete-error></p>
      </section>
    </form>
  </div>
  <div class="host-drawer-footer">
    <span class="host-drawer-footer-status" data-host-drawer-dirty>No changes</span>
    <div class="host-drawer-footer-actions">
      <button class="btn btn-secondary" type="button" data-host-drawer-cancel>Cancel</button>
      <button class="btn btn-primary" type="submit" form="host-edit-form" data-host-drawer-save data-host-mode-action="edit" disabled>Save changes</button>
      <button class="btn btn-danger" type="submit" form="host-delete-form" data-host-drawer-delete data-host-mode-action="delete" hidden disabled>Delete permanently</button>
    </div>
  </div>
</aside>


<script src="/static/js/drawer.js" defer></script>
<script src="/static/js/hosts.js" defer></script>
{% endblock %}
