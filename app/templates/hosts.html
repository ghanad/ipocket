{% extends "base.html" %}

{% block content %}
<section class="page-header">
  <div>
    <p class="eyebrow">Inventory</p>
    <h1>Hosts</h1>
    <p class="subtitle">Track physical hosts and linked OS/BMC addresses.</p>
  </div>
</section>

{% if errors %}
<div class="alert alert-error">
  <ul>{% for error in errors %}<li>{{ error }}</li>{% endfor %}</ul>
</div>
{% endif %}

<section>
  <details class="card compact-card collapsible-card filter-card" id="host-search-card"{% if show_search %} open{% endif %}>
    <summary class="card-header collapsible-summary">
      <div>
        <h2>Search Hosts</h2>
        <p class="subtitle">Filter by host name, vendor, project, notes, or linked IPs.</p>
      </div>
      <span class="collapsible-indicator" aria-hidden="true">▸</span>
    </summary>
    <form class="filters-grid" method="get" action="/ui/hosts">
      <label class="field">
        <span>Search</span>
        <input
          class="input"
          type="text"
          name="q"
          value="{{ filters.q }}"
          placeholder="Name, vendor, project, notes, or IP"
        />
      </label>
      <div class="form-actions">
        <button class="btn btn-primary" type="submit">Apply</button>
        <a class="btn btn-secondary" href="/ui/hosts">Clear</a>
      </div>
    </form>
  </details>
</section>

<section>
  <details class="card compact-card collapsible-card host-add-card" id="add-host-card"{% if show_add_host %} open{% endif %}>
    <summary class="card-header collapsible-summary">
      <div>
        <h2>Add Host</h2>
        <p class="subtitle">Create a new host before assigning IP addresses.</p>
      </div>
      <span class="collapsible-indicator" aria-hidden="true">▸</span>
    </summary>
    <form class="form-grid form-grid-two" method="post" action="/ui/hosts">
      <label class="field">
        <span>Name</span>
        <input class="input" type="text" name="name" value="{{ form_state.name }}" />
      </label>
      <label class="field">
        <span>Vendor</span>
        <select class="select" name="vendor_id">
          <option value="">UNASSIGNED</option>
          {% for vendor in vendors %}
          <option value="{{ vendor.id }}"{% if form_state.vendor_id == (vendor.id|string) %} selected{% endif %}>{{ vendor.name }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="field">
        <span>OS IPs</span>
        <input
          class="input"
          type="text"
          name="os_ips"
          value="{{ form_state.os_ips }}"
          placeholder="10.0.0.10, 10.0.0.11"
        />
      </label>
      <label class="field">
        <span>BMC IPs</span>
        <input
          class="input"
          type="text"
          name="bmc_ips"
          value="{{ form_state.bmc_ips }}"
          placeholder="10.0.0.20, 10.0.0.21"
        />
      </label>
      <label class="field field-span">
        <span>Notes</span>
        <textarea class="textarea" name="notes" rows="2">{{ form_state.notes }}</textarea>
      </label>
      <div class="form-actions field-span">
        <button class="btn btn-primary" type="submit">Add Host</button>
      </div>
    </form>
  </details>
</section>

<section class="card table-card">
  <div class="table-wrapper">
    <table class="table">
      <thead>
        <tr>
          <th>Host name</th>
          <th>Vendor</th>
          <th>Project</th>
          <th>OS IPs</th>
          <th>BMC IPs</th>
          <th>Linked IPs</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if hosts %}
        {% for host in hosts %}
        <tr>
          <td><a href="/ui/hosts/{{ host.id }}">{{ host.name }}</a></td>
          <td>{{ host.vendor or "" }}</td>
          <td>
            {% if host.project_count == 0 %}
            <span class="tag tag-warning">Unassigned</span>
            {% elif host.project_count > 1 %}
            <span class="tag tag-warning">Multiple</span>
            {% else %}
            <span class="tag tag-project" style="--project-color: {{ host.project_color or '#94a3b8' }}">
              {{ host.project_name }}
            </span>
            {% endif %}
          </td>
          <td>{{ host.os_ips or "" }}</td>
          <td>{{ host.bmc_ips or "" }}</td>
          <td>{{ host.ip_count }}</td>
          <td class="asset-actions-cell">
            {% set vendor_match = namespace(id="") %}
            {% for vendor in vendors %}
            {% if host.vendor and vendor.name == host.vendor %}
            {% set vendor_match.id = vendor.id %}
            {% endif %}
            {% endfor %}
            <div class="table-actions">
              <button
                class="btn btn-secondary btn-small"
                type="button"
                data-host-edit="{{ host.id }}"
                data-host-name="{{ host.name }}"
                data-host-vendor-id="{{ vendor_match.id }}"
                data-host-os-ips="{{ host.os_ips or "" }}"
                data-host-bmc-ips="{{ host.bmc_ips or "" }}"
                data-host-notes="{{ host.notes or "" }}"
              >
                Edit
              </button>
              <a class="btn btn-danger btn-small" href="/ui/hosts/{{ host.id }}/delete">Delete</a>
            </div>
          </td>
        </tr>
        {% endfor %}
        {% else %}
        <tr><td colspan="7" class="empty-state">No hosts found.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</section>

<div class="host-drawer-overlay" data-host-drawer-overlay aria-hidden="true"></div>
<aside class="host-drawer" data-host-drawer role="dialog" aria-modal="true" aria-label="Edit Host">
  <div class="host-drawer-header">
    <div class="host-drawer-header-row">
      <div>
        <h2 class="host-drawer-title">Edit Host</h2>
        <p class="host-drawer-subtitle" data-host-drawer-subtitle>—</p>
      </div>
      <button class="host-drawer-close" type="button" aria-label="Close edit drawer" data-host-drawer-close>
        ✕
      </button>
    </div>
  </div>
  <div class="host-drawer-body">
    <form class="host-drawer-form" method="post" data-host-edit-form id="host-edit-form">
      <label class="field">
        <span>Name</span>
        <input class="input" type="text" name="name" required data-host-input="name" />
        <span class="host-drawer-error" data-host-error="name" role="alert"></span>
      </label>
      <label class="field">
        <span>Vendor</span>
        <select class="select" name="vendor_id" data-host-input="vendor_id">
          <option value="">UNASSIGNED</option>
          {% for vendor in vendors %}
          <option value="{{ vendor.id }}">{{ vendor.name }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="field">
        <span>OS IP</span>
        <input class="input" type="text" name="os_ips" placeholder="e.g. 192.168.10.200" data-host-input="os_ips" />
        <span class="host-drawer-error" data-host-error="os_ips" role="alert"></span>
      </label>
      <label class="field">
        <span>BMC IP</span>
        <input class="input" type="text" name="bmc_ips" placeholder="e.g. 192.168.20.10" data-host-input="bmc_ips" />
        <span class="host-drawer-error" data-host-error="bmc_ips" role="alert"></span>
      </label>
      <label class="field field-span">
        <span>Notes</span>
        <textarea class="textarea" name="notes" rows="3" data-host-input="notes"></textarea>
      </label>
    </form>
  </div>
  <div class="host-drawer-footer">
    <button class="btn btn-secondary" type="button" data-host-drawer-cancel>Cancel</button>
    <button class="btn btn-primary" type="submit" form="host-edit-form" data-host-drawer-save disabled>Save changes</button>
  </div>
</aside>

<style>
  .host-drawer-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.45);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    z-index: 40;
  }

  .host-drawer-overlay.is-open {
    opacity: 1;
    pointer-events: auto;
  }

  .host-drawer {
    position: fixed;
    top: 0;
    right: 0;
    height: 100vh;
    width: min(520px, 92vw);
    background: var(--color-surface);
    border-left: 1px solid var(--color-border);
    box-shadow: 0 18px 32px rgba(15, 23, 42, 0.18);
    transform: translateX(105%);
    transition: transform 0.25s ease;
    display: flex;
    flex-direction: column;
    z-index: 50;
  }

  .host-drawer.is-open {
    transform: translateX(0);
  }

  .host-drawer-header {
    padding: 18px 20px 12px;
    border-bottom: 1px solid var(--color-border);
    background: #fbfdff;
  }

  .host-drawer-header-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 16px;
  }

  .host-drawer-title {
    font-size: 18px;
    margin: 0;
    word-break: break-word;
  }

  .host-drawer-subtitle {
    margin: 4px 0 0;
    font-size: 13px;
    color: var(--color-muted);
    word-break: break-word;
  }

  .host-drawer-close {
    border: 1px solid var(--color-border);
    background: #fff;
    border-radius: 10px;
    width: 36px;
    height: 36px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }

  .host-drawer-body {
    padding: 18px 20px 120px;
    overflow-y: auto;
  }

  .host-drawer-form {
    display: grid;
    gap: 16px;
  }

  .host-drawer-footer {
    position: sticky;
    bottom: 0;
    padding: 12px 20px;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    background: rgba(255, 255, 255, 0.95);
    border-top: 1px solid var(--color-border);
    backdrop-filter: blur(6px);
  }

  .host-drawer-error {
    display: none;
    color: var(--color-danger);
    font-size: 12px;
    font-weight: 600;
    min-height: 16px;
  }
</style>

<script>
(() => {
  const overlay = document.querySelector("[data-host-drawer-overlay]");
  const drawer = document.querySelector("[data-host-drawer]");
  const drawerSubtitle = document.querySelector("[data-host-drawer-subtitle]");
  const closeButton = document.querySelector("[data-host-drawer-close]");
  const cancelButton = document.querySelector("[data-host-drawer-cancel]");
  const saveButton = document.querySelector("[data-host-drawer-save]");
  const form = document.querySelector("[data-host-edit-form]");
  const inputs = form ? form.querySelectorAll("[data-host-input]") : [];
  const errorMessages = form ? form.querySelectorAll("[data-host-error]") : [];
  let initialValues = {};
  let isOpen = false;

  if (!overlay || !drawer || !form || !drawerSubtitle || !closeButton || !cancelButton || !saveButton) {
    return;
  }

  const isValidIPv4 = (value) => {
    if (!value) return true;
    const trimmed = value.trim();
    const regex = /^(25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)){3}$/;
    return regex.test(trimmed);
  };

  const setError = (field, message) => {
    const error = form.querySelector(`[data-host-error="${field}"]`);
    if (!error) return;
    if (message) {
      error.textContent = message;
      error.style.display = "block";
    } else {
      error.textContent = "";
      error.style.display = "none";
    }
  };

  const clearErrors = () => {
    errorMessages.forEach((error) => {
      error.textContent = "";
      error.style.display = "none";
    });
  };

  const normalizeValue = (value) => value.trim();

  const isDirty = () =>
    Array.from(inputs).some((input) => {
      const key = input.dataset.hostInput;
      return normalizeValue(input.value) !== (initialValues[key] || "");
    });

  const validate = () => {
    let valid = true;
    const nameInput = form.querySelector('[data-host-input="name"]');
    const osInput = form.querySelector('[data-host-input="os_ips"]');
    const bmcInput = form.querySelector('[data-host-input="bmc_ips"]');

    if (nameInput && !nameInput.value.trim()) {
      setError("name", "Host name is required.");
      valid = false;
    } else {
      setError("name", "");
    }

    if (osInput && osInput.value.trim() && !isValidIPv4(osInput.value)) {
      setError("os_ips", "Enter a valid IPv4 address.");
      valid = false;
    } else {
      setError("os_ips", "");
    }

    if (bmcInput && bmcInput.value.trim() && !isValidIPv4(bmcInput.value)) {
      setError("bmc_ips", "Enter a valid IPv4 address.");
      valid = false;
    } else {
      setError("bmc_ips", "");
    }

    return valid;
  };

  const updateSaveState = () => {
    const dirty = isDirty();
    const valid = validate();
    saveButton.disabled = !(dirty && valid);
  };

  const openDrawer = (hostData) => {
    clearErrors();
    inputs.forEach((input) => {
      const key = input.dataset.hostInput;
      input.value = hostData[key] || "";
    });
    form.action = `/ui/hosts/${hostData.id}/edit`;
    drawerSubtitle.textContent = hostData.name || "—";
    initialValues = {
      name: hostData.name || "",
      vendor_id: hostData.vendor_id || "",
      os_ips: hostData.os_ips || "",
      bmc_ips: hostData.bmc_ips || "",
      notes: hostData.notes || "",
    };
    updateSaveState();
    overlay.classList.add("is-open");
    drawer.classList.add("is-open");
    isOpen = true;
  };

  const closeDrawer = () => {
    overlay.classList.remove("is-open");
    drawer.classList.remove("is-open");
    isOpen = false;
  };

  const confirmClose = () => {
    if (!isDirty()) {
      closeDrawer();
      return;
    }
    if (window.confirm("Discard changes?")) {
      closeDrawer();
    }
  };

  document.querySelectorAll("[data-host-edit]").forEach((button) => {
    button.addEventListener("click", () => {
      const hostData = {
        id: button.dataset.hostEdit,
        name: button.dataset.hostName || "",
        vendor_id: button.dataset.hostVendorId || "",
        os_ips: button.dataset.hostOsIps || "",
        bmc_ips: button.dataset.hostBmcIps || "",
        notes: button.dataset.hostNotes || "",
      };
      openDrawer(hostData);
    });
  });

  closeButton.addEventListener("click", confirmClose);
  cancelButton.addEventListener("click", confirmClose);
  overlay.addEventListener("click", confirmClose);

  document.addEventListener("keydown", (event) => {
    if (event.key === "Escape" && isOpen) {
      confirmClose();
    }
  });

  inputs.forEach((input) => {
    input.addEventListener("input", () => {
      updateSaveState();
    });
  });

  form.addEventListener("submit", (event) => {
    if (!validate()) {
      event.preventDefault();
      updateSaveState();
    }
  });
})();
</script>
{% endblock %}
