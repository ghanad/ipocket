{% extends "base.html" %}

{% block content %}
<section class="page-header">
  <div>
    <p class="eyebrow">Inventory</p>
    <h1>IP Assets</h1>
    <p class="subtitle">Manage and monitor network address assignments across all zones.</p>
  </div>
  <div class="header-actions">
    <a class="btn btn-primary" href="/ui/ip-assets/new">Add IP</a>
    <a class="btn btn-secondary" href="/ui/ip-assets/needs-assignment">Needs Assignment</a>
  </div>
</section>
{% if bulk_error %}
<div class="alert alert-error">
  {{ bulk_error }}
</div>
{% endif %}
{% if bulk_success %}
<div class="alert alert-success">
  {{ bulk_success }}
</div>
{% endif %}
<section class="card filter-card">
  <form class="filters-grid" method="get" action="/ui/ip-assets">
    <label class="field">
      <span>Search</span>
      <input
        class="input"
        type="text"
        name="q"
        value="{{ filters.q }}"
        placeholder="IP or notes"
        hx-get="/ui/ip-assets"
        hx-trigger="keyup changed delay:500ms, search"
        hx-target="#ip-table-container"
        hx-push-url="true"
        hx-include="closest form"
      />
    </label>
    <label class="field">
      <span>Project</span>
      <select
        class="select"
        name="project_id"
        hx-get="/ui/ip-assets"
        hx-trigger="change"
        hx-target="#ip-table-container"
        hx-push-url="true"
        hx-include="closest form"
      >
        <option value="">All</option>
        {% for project in projects %}
        <option value="{{ project.id }}"{% if filters.project_id == project.id %} selected{% endif %}>{{ project.name }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="field">
      <span>Type</span>
      <select
        class="select"
        name="type"
        hx-get="/ui/ip-assets"
        hx-trigger="change"
        hx-target="#ip-table-container"
        hx-push-url="true"
        hx-include="closest form"
      >
        <option value="">All</option>
        {% for asset_type in types %}
        <option value="{{ asset_type }}"{% if filters.type == asset_type %} selected{% endif %}>{{ asset_type }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="field">
      <span>Assignment</span>
      <select
        class="select"
        name="unassigned-only"
        hx-get="/ui/ip-assets"
        hx-trigger="change"
        hx-target="#ip-table-container"
        hx-push-url="true"
        hx-include="closest form"
      >
        <option value="false"{% if not filters.unassigned_only %} selected{% endif %}>All</option>
        <option value="true"{% if filters.unassigned_only %} selected{% endif %}>Unassigned only</option>
      </select>
    </label>
    <label class="field">
      <span>Status</span>
      <select
        class="select"
        name="archived-only"
        hx-get="/ui/ip-assets"
        hx-trigger="change"
        hx-target="#ip-table-container"
        hx-push-url="true"
        hx-include="closest form"
      >
        <option value="false"{% if not filters.archived_only %} selected{% endif %}>Active only</option>
        <option value="true"{% if filters.archived_only %} selected{% endif %}>Archived only</option>
      </select>
    </label>
    <label class="field">
      <span>Per page</span>
      <select
        class="select"
        name="per-page"
        hx-get="/ui/ip-assets"
        hx-trigger="change"
        hx-target="#ip-table-container"
        hx-push-url="true"
        hx-include="closest form"
      >
        {% for option in [10, 20, 50, 100] %}
        <option value="{{ option }}"{% if filters.per_page == option %} selected{% endif %}>{{ option }}</option>
        {% endfor %}
      </select>
    </label>
  </form>
</section>

<div id="ip-table-container">
  {% include "partials/ip_assets_table.html" %}
</div>

<script>
  (() => {
    const POSITION_MARGIN = 12;
    const GLOBAL_FLAG = 'ipocketRowActionsInitialized';

    const positionMenuPanel = (toggle, panel) => {
      const triggerRect = toggle.getBoundingClientRect();
      panel.style.position = 'fixed';
      panel.style.top = '0';
      panel.style.left = '0';
      panel.style.right = 'auto';
      panel.style.bottom = 'auto';
      panel.style.visibility = 'hidden';
      panel.hidden = false;

      const panelRect = panel.getBoundingClientRect();
      let top = triggerRect.bottom + 6;
      let left = triggerRect.right - panelRect.width;

      if (left < POSITION_MARGIN) {
        left = POSITION_MARGIN;
      }

      if (left + panelRect.width > window.innerWidth - POSITION_MARGIN) {
        left = Math.max(POSITION_MARGIN, window.innerWidth - panelRect.width - POSITION_MARGIN);
      }

      if (top + panelRect.height > window.innerHeight - POSITION_MARGIN) {
        top = triggerRect.top - panelRect.height - 6;
      }

      if (top < POSITION_MARGIN) {
        top = POSITION_MARGIN;
      }

      panel.style.top = `${top}px`;
      panel.style.left = `${left}px`;
      panel.style.visibility = 'visible';
    };

    const closeAllMenus = () => {
      const actionMenus = document.querySelectorAll('[data-row-actions]');
      actionMenus.forEach((menu) => {
        const toggle = menu.querySelector('[data-row-actions-toggle]');
        const panel = menu.querySelector('[data-row-actions-panel]');
        if (toggle && panel) {
          toggle.setAttribute('aria-expanded', 'false');
          panel.hidden = true;
          panel.style.visibility = '';
          menu.classList.remove('is-open');
        }
      });
    };

    const bindRowActions = (root = document) => {
      const actionMenus = root.querySelectorAll('[data-row-actions]');
      actionMenus.forEach((menu) => {
        if (menu.dataset.rowActionsBound) {
          return;
        }
        const toggle = menu.querySelector('[data-row-actions-toggle]');
        const panel = menu.querySelector('[data-row-actions-panel]');
        if (!toggle || !panel) {
          return;
        }
        menu.dataset.rowActionsBound = 'true';

        toggle.addEventListener('click', (event) => {
          event.stopPropagation();
          const isOpen = toggle.getAttribute('aria-expanded') === 'true';
          closeAllMenus();
          if (!isOpen) {
            toggle.setAttribute('aria-expanded', 'true');
            positionMenuPanel(toggle, panel);
            menu.classList.add('is-open');
          }
        });

        panel.addEventListener('click', (event) => {
          event.stopPropagation();
        });
      });

      const openButtons = root.querySelectorAll('[data-delete-dialog-id]');
      openButtons.forEach((button) => {
        if (button.dataset.deleteDialogBound) {
          return;
        }
        button.dataset.deleteDialogBound = 'true';
        button.addEventListener('click', () => {
          const dialog = document.getElementById(button.dataset.deleteDialogId);
          if (dialog && typeof dialog.showModal === 'function') {
            dialog.showModal();
          }
        });
      });

      const closeButtons = root.querySelectorAll('[data-close-delete-dialog]');
      closeButtons.forEach((button) => {
        if (button.dataset.closeDialogBound) {
          return;
        }
        button.dataset.closeDialogBound = 'true';
        button.addEventListener('click', () => {
          const dialog = button.closest('dialog');
          if (dialog) {
            dialog.close();
          }
        });
      });
    };

    const bindBulkEdit = (root = document) => {
      const bulkForm = root.querySelector('[data-bulk-form]');
      if (!bulkForm || bulkForm.dataset.bulkBound) {
        return;
      }
      bulkForm.dataset.bulkBound = 'true';
      const selectAll = bulkForm.querySelector('[data-bulk-select-all]');
      const checkboxes = Array.from(bulkForm.querySelectorAll('[data-bulk-select]'));
      const countLabel = bulkForm.querySelector('[data-selected-count]');
      const submitButton = bulkForm.querySelector('[data-bulk-submit]');
      const bulkControls = bulkForm.querySelector('[data-bulk-controls]');

      const updateCount = () => {
        const selectedCount = checkboxes.filter((checkbox) => checkbox.checked).length;
        if (countLabel) {
          countLabel.textContent = `${selectedCount} selected`;
        }
        if (submitButton) {
          submitButton.disabled = selectedCount === 0;
        }
        if (bulkControls) {
          bulkControls.classList.toggle('bulk-edit-controls-hidden', selectedCount === 0);
        }
        if (selectAll) {
          selectAll.indeterminate = selectedCount > 0 && selectedCount < checkboxes.length;
          selectAll.checked = selectedCount > 0 && selectedCount === checkboxes.length;
        }
      };

      if (selectAll) {
        selectAll.addEventListener('change', () => {
          const shouldCheck = selectAll.checked;
          checkboxes.forEach((checkbox) => {
            checkbox.checked = shouldCheck;
          });
          updateCount();
        });
      }

      checkboxes.forEach((checkbox) => {
        checkbox.addEventListener('change', () => {
          updateCount();
        });
      });

      updateCount();
    };

    if (!window[GLOBAL_FLAG]) {
      window[GLOBAL_FLAG] = true;
      document.addEventListener('click', () => {
        closeAllMenus();
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          closeAllMenus();
        }
      });

      window.addEventListener(
        'scroll',
        () => {
          closeAllMenus();
        },
        true,
      );

      const tableWrapper = document.querySelector('.table-wrapper');
      if (tableWrapper) {
        tableWrapper.addEventListener('scroll', () => {
          closeAllMenus();
        });
      }

      window.addEventListener('resize', () => {
        closeAllMenus();
      });

      document.body.addEventListener('htmx:afterSwap', (event) => {
        if (event.target && event.target.id === 'ip-table-container') {
          bindRowActions(event.target);
          bindBulkEdit(event.target);
          closeAllMenus();
        }
      });
    }

    bindRowActions();
    bindBulkEdit();
  })();
</script>
{% endblock %}
