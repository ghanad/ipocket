{% extends "base.html" %}

{% block content %}
<section class="page-header">
  <div>
    <p class="eyebrow">Inventory</p>
    <h1>IP Assets</h1>
    <p class="subtitle">Manage and monitor network address assignments across all zones.</p>
  </div>
  <div class="header-actions">
    <a class="btn btn-primary" href="/ui/ip-assets/new">Add IP</a>
    <a class="btn btn-secondary" href="/ui/ip-assets/needs-assignment">Needs Assignment</a>
  </div>
</section>
<section class="card filter-card">
  <form class="filters-grid" method="get" action="/ui/ip-assets">
    <label class="field">
      <span>Search</span>
      <input class="input" type="text" name="q" value="{{ filters.q }}" placeholder="IP or notes" />
    </label>
    <label class="field">
      <span>Project</span>
      <select class="select" name="project_id">
        <option value="">All</option>
        {% for project in projects %}
        <option value="{{ project.id }}"{% if filters.project_id == project.id %} selected{% endif %}>{{ project.name }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="field">
      <span>Type</span>
      <select class="select" name="type">
        <option value="">All</option>
        {% for asset_type in types %}
        <option value="{{ asset_type }}"{% if filters.type == asset_type %} selected{% endif %}>{{ asset_type }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="checkbox-field">
      <input type="checkbox" name="unassigned-only" value="true"{% if filters.unassigned_only %} checked{% endif %} />
      <span>Unassigned only</span>
    </label>
    <button class="btn btn-outline" type="submit">Apply filters</button>
  </form>
</section>

<section class="card table-card">
  <div class="table-wrapper">
    <table class="table">
      <thead>
        <tr>
          <th>IP address</th>
          <th>Project</th>
          <th>Type</th>
          <th>Notes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if assets %}
        {% for asset in assets %}
        <tr>
          <td class="mono"><a href="/ui/ip-assets/{{ asset.id }}">{{ asset.ip_address }}</a></td>
          <td>
            {% if asset.project_unassigned %}
            <span class="tag tag-warning">Unassigned</span>
            {% else %}
            <span class="tag tag-project" style="--project-color: {{ asset.project_color or '#94a3b8' }}">
              {{ asset.project_name }}
            </span>
            {% endif %}
          </td>
          <td class="muted">{{ asset.type }}</td>
          <td class="muted">{{ asset.notes }}</td>
          <td class="asset-actions-cell">
            <div class="row-actions-menu" data-row-actions>
              <button
                class="row-actions-trigger"
                type="button"
                aria-label="Open actions for {{ asset.ip_address }}"
                aria-expanded="false"
                aria-haspopup="true"
                aria-controls="row-actions-{{ asset.id }}"
                data-row-actions-toggle
              >
                <span class="row-actions-icon" aria-hidden="true">‚ãÆ</span>
              </button>
              <div
                class="row-actions-panel"
                id="row-actions-{{ asset.id }}"
                role="menu"
                aria-label="Actions for {{ asset.ip_address }}"
                data-row-actions-panel
                hidden
              >
                <a class="row-action-item" role="menuitem" href="/ui/ip-assets/{{ asset.id }}/edit">
                  <span aria-hidden="true">‚úèÔ∏è</span>
                  <span>Edit</span>
                </a>
                <button
                  class="row-action-item row-action-item-danger"
                  type="button"
                  role="menuitem"
                  data-delete-dialog-id="delete-ip-{{ asset.id }}"
                >
                  <span aria-hidden="true">üóëÔ∏è</span>
                  <span>Delete</span>
                </button>
              </div>
            </div>

            <dialog class="delete-confirm-dialog" id="delete-ip-{{ asset.id }}">
              <form method="dialog" class="delete-confirm-dialog-card">
                <h2>Delete IP asset?</h2>
                <p>
                  <strong>{{ asset.ip_address }}</strong> will be removed permanently. You can review details on the
                  confirmation page before deletion.
                </p>
                <div class="delete-confirm-dialog-actions">
                  <button type="button" class="btn btn-secondary" data-close-delete-dialog>Cancel</button>
                  <a class="btn btn-danger" href="/ui/ip-assets/{{ asset.id }}/delete">Continue to delete</a>
                </div>
              </form>
            </dialog>
          </td>
        </tr>
        {% endfor %}
        {% else %}
        <tr>
          <td colspan="7" class="empty-state">No IP assets found.</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</section>

<script>
  (() => {
    const actionMenus = document.querySelectorAll('[data-row-actions]');
    const POSITION_MARGIN = 12;

    const positionMenuPanel = (toggle, panel) => {
      const triggerRect = toggle.getBoundingClientRect();
      panel.style.position = 'fixed';
      panel.style.top = '0';
      panel.style.left = '0';
      panel.style.right = 'auto';
      panel.style.bottom = 'auto';
      panel.style.visibility = 'hidden';
      panel.hidden = false;

      const panelRect = panel.getBoundingClientRect();
      let top = triggerRect.bottom + 6;
      let left = triggerRect.right - panelRect.width;

      if (left < POSITION_MARGIN) {
        left = POSITION_MARGIN;
      }

      if (left + panelRect.width > window.innerWidth - POSITION_MARGIN) {
        left = Math.max(POSITION_MARGIN, window.innerWidth - panelRect.width - POSITION_MARGIN);
      }

      if (top + panelRect.height > window.innerHeight - POSITION_MARGIN) {
        top = triggerRect.top - panelRect.height - 6;
      }

      if (top < POSITION_MARGIN) {
        top = POSITION_MARGIN;
      }

      panel.style.top = `${top}px`;
      panel.style.left = `${left}px`;
      panel.style.visibility = 'visible';
    };

    const closeAllMenus = () => {
      actionMenus.forEach((menu) => {
        const toggle = menu.querySelector('[data-row-actions-toggle]');
        const panel = menu.querySelector('[data-row-actions-panel]');
        if (toggle && panel) {
          toggle.setAttribute('aria-expanded', 'false');
          panel.hidden = true;
          panel.style.visibility = '';
          menu.classList.remove('is-open');
        }
      });
    };

    actionMenus.forEach((menu) => {
      const toggle = menu.querySelector('[data-row-actions-toggle]');
      const panel = menu.querySelector('[data-row-actions-panel]');
      if (!toggle || !panel) {
        return;
      }

      toggle.addEventListener('click', (event) => {
        event.stopPropagation();
        const isOpen = toggle.getAttribute('aria-expanded') === 'true';
        closeAllMenus();
        if (!isOpen) {
          toggle.setAttribute('aria-expanded', 'true');
          positionMenuPanel(toggle, panel);
          menu.classList.add('is-open');
        }
      });

      panel.addEventListener('click', (event) => {
        event.stopPropagation();
      });
    });

    document.addEventListener('click', () => {
      closeAllMenus();
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeAllMenus();
      }
    });

    window.addEventListener(
      'scroll',
      () => {
        closeAllMenus();
      },
      true,
    );

    const tableWrapper = document.querySelector('.table-wrapper');
    if (tableWrapper) {
      tableWrapper.addEventListener('scroll', () => {
        closeAllMenus();
      });
    }

    window.addEventListener('resize', () => {
      closeAllMenus();
    });

    const openButtons = document.querySelectorAll('[data-delete-dialog-id]');
    openButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const dialog = document.getElementById(button.dataset.deleteDialogId);
        if (dialog && typeof dialog.showModal === 'function') {
          dialog.showModal();
        }
      });
    });

    const closeButtons = document.querySelectorAll('[data-close-delete-dialog]');
    closeButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const dialog = button.closest('dialog');
        if (dialog) {
          dialog.close();
        }
      });
    });
  })();
</script>
{% endblock %}
