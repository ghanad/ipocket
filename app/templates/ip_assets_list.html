{% extends "base.html" %}

{% block content %}
<section class="page-header">
  <div>
    <p class="eyebrow">Inventory</p>
    <h1>IP Assets</h1>
    <p class="subtitle">Manage and monitor network address assignments across all zones.</p>
  </div>
  <div class="header-actions">
    <a class="btn btn-primary" href="/ui/ip-assets/new">Add IP</a>
    <a class="btn btn-secondary" href="/ui/ip-assets/needs-assignment">Needs Assignment</a>
  </div>
</section>
<section class="card filter-card">
  <form class="filters-grid" method="get" action="/ui/ip-assets">
    <label class="field">
      <span>Search</span>
      <input
        class="input"
        type="text"
        name="q"
        value="{{ filters.q }}"
        placeholder="IP or notes"
        hx-get="/ui/ip-assets"
        hx-trigger="keyup changed delay:500ms, search"
        hx-target="#ip-table-container"
        hx-push-url="true"
        hx-include="closest form"
      />
    </label>
    <label class="field">
      <span>Project</span>
      <select
        class="select"
        name="project_id"
        hx-get="/ui/ip-assets"
        hx-trigger="change"
        hx-target="#ip-table-container"
        hx-push-url="true"
        hx-include="closest form"
      >
        <option value="">All</option>
        {% for project in projects %}
        <option value="{{ project.id }}"{% if filters.project_id == project.id %} selected{% endif %}>{{ project.name }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="field">
      <span>Type</span>
      <select
        class="select"
        name="type"
        hx-get="/ui/ip-assets"
        hx-trigger="change"
        hx-target="#ip-table-container"
        hx-push-url="true"
        hx-include="closest form"
      >
        <option value="">All</option>
        {% for asset_type in types %}
        <option value="{{ asset_type }}"{% if filters.type == asset_type %} selected{% endif %}>{{ asset_type }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="field field-tag-filter">
      <span>Tag</span>
      <div class="tag-filter-controls">
        <select
          class="select"
          name="tag"
          multiple
          hx-get="/ui/ip-assets"
          hx-trigger="change"
          hx-target="#ip-table-container"
          hx-push-url="true"
          hx-include="closest form"
        >
{% for tag in tags %}
          <option value="{{ tag.name }}"{% if tag.name in filters.tag %} selected{% endif %}>{{ tag.name }}</option>
          {% endfor %}
        </select>
        <button class="btn btn-secondary btn-small" type="button" data-clear-tag-filter>Clear</button>
      </div>
      <small class="muted">Multi-select (ANY match). Use Ctrl/Cmd-click or quick tags in table.</small>
    </label>
    <label class="field">
      <span>Assignment</span>
      <select
        class="select"
        name="unassigned-only"
        hx-get="/ui/ip-assets"
        hx-trigger="change"
        hx-target="#ip-table-container"
        hx-push-url="true"
        hx-include="closest form"
      >
        <option value="false"{% if not filters.unassigned_only %} selected{% endif %}>All</option>
        <option value="true"{% if filters.unassigned_only %} selected{% endif %}>Unassigned only</option>
      </select>
    </label>
    <label class="field">
      <span>Status</span>
      <select
        class="select"
        name="archived-only"
        hx-get="/ui/ip-assets"
        hx-trigger="change"
        hx-target="#ip-table-container"
        hx-push-url="true"
        hx-include="closest form"
      >
        <option value="false"{% if not filters.archived_only %} selected{% endif %}>Active only</option>
        <option value="true"{% if filters.archived_only %} selected{% endif %}>Archived only</option>
      </select>
    </label>
  </form>
</section>

<div id="ip-table-container">
  {% include "partials/ip_assets_table.html" %}
</div>

<div class="ip-drawer-overlay" data-ip-drawer-overlay aria-hidden="true"></div>
<aside class="ip-drawer" data-ip-drawer role="dialog" aria-modal="true" aria-label="Edit IP asset">
  <div class="ip-drawer-header">
    <div class="ip-drawer-header-row">
      <div>
        <h2 class="ip-drawer-title">Edit IP asset</h2>
        <p class="ip-drawer-subtitle" data-ip-drawer-subtitle>—</p>
      </div>
      <button class="ip-drawer-close" type="button" aria-label="Close edit drawer" data-ip-drawer-close>
        ✕
      </button>
    </div>
    <div class="ip-drawer-meta">
      <span class="ip-drawer-pill" data-ip-drawer-project>Project: Unassigned</span>
      <span class="ip-drawer-pill ip-drawer-pill-muted" data-ip-drawer-host>Host: —</span>
    </div>
  </div>
  <div class="ip-drawer-body">
    <form class="ip-drawer-form" method="post" data-ip-edit-form id="ip-edit-form">
      <input type="hidden" name="return_to" value="{{ return_to }}">
      <section class="ip-drawer-section">
        <h3>Assignment</h3>
        <label class="field">
          <span>IP address</span>
          <input class="input" type="text" name="ip_address" readonly data-ip-input="ip_address" />
        </label>
        <div class="ip-drawer-row ip-drawer-row-two">
          <label class="field">
            <span>Type</span>
            <select class="select" name="type" data-ip-input="type">
              {% for asset_type in types %}
              <option value="{{ asset_type }}">{{ asset_type }}</option>
              {% endfor %}
            </select>
          </label>
          <label class="field">
            <span>Project</span>
            <select class="select" name="project_id" data-ip-input="project_id">
              <option value="">Unassigned</option>
              {% for project in projects %}
              <option value="{{ project.id }}">{{ project.name }}</option>
              {% endfor %}
            </select>
          </label>
        </div>
        <label class="field" data-ip-host-field>
          <span>Host</span>
          <select class="select" name="host_id" data-ip-input="host_id">
            <option value="">Unassigned</option>
            {% for host in hosts %}
            <option value="{{ host.id }}">{{ host.name }}</option>
            {% endfor %}
          </select>
        </label>
        <div class="ip-drawer-auto-host" data-ip-auto-host>
          <button class="btn btn-outline btn-small" type="button" data-ip-auto-host-button>
            Create host
          </button>
          <p class="ip-drawer-helper" data-ip-auto-host-hint>
            Creates and assigns a host named <span class="mono" data-ip-auto-host-name>server_IP</span>.
          </p>
          <p class="ip-drawer-helper ip-drawer-helper-error" data-ip-auto-host-status></p>
        </div>
      </section>
      <section class="ip-drawer-section">
        <h3>Notes & tags</h3>
        <label class="field">
          <span>Tags</span>
          <input class="input" type="text" name="tags" placeholder="comma,separated" data-ip-input="tags" />
        </label>
        <label class="field">
          <span>Notes</span>
          <textarea class="textarea" name="notes" rows="3" data-ip-input="notes"></textarea>
        </label>
      </section>
    </form>
  </div>
  <div class="ip-drawer-footer">
    <span class="ip-drawer-footer-status" data-ip-drawer-dirty>No changes</span>
    <div class="ip-drawer-footer-actions">
      <button class="btn btn-secondary" type="button" data-ip-drawer-cancel>Cancel</button>
      <button class="btn btn-primary" type="submit" form="ip-edit-form" data-ip-drawer-save disabled>
        Save changes
      </button>
    </div>
  </div>
</aside>

<style>
  .ip-asset-actions {
    display: inline-flex;
    gap: 8px;
    flex-wrap: nowrap;
    align-items: center;
  }

  .tag-filter-chip {
    border: none;
    font: inherit;
    cursor: pointer;
  }

  .ip-drawer-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.45);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    z-index: 40;
  }

  .ip-drawer-overlay.is-open {
    opacity: 1;
    pointer-events: auto;
  }

  .ip-drawer {
    position: fixed;
    top: 0;
    right: 0;
    height: 100%;
    width: min(480px, 100%);
    background: #fff;
    box-shadow: -24px 0 48px rgba(15, 23, 42, 0.16);
    transform: translateX(100%);
    transition: transform 0.24s ease;
    z-index: 50;
    display: flex;
    flex-direction: column;
  }

  .ip-drawer.is-open {
    transform: translateX(0);
  }

  .ip-drawer-header {
    padding: 20px 24px 12px;
    border-bottom: 1px solid #e2e8f0;
  }

  .ip-drawer-header-row {
    display: flex;
    justify-content: space-between;
    gap: 12px;
    align-items: center;
  }

  .ip-drawer-title {
    margin: 0;
    font-size: 20px;
  }

  .ip-drawer-subtitle {
    margin: 4px 0 0;
    color: #64748b;
  }

  .ip-drawer-meta {
    margin-top: 12px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .ip-drawer-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 999px;
    background: #f1f5f9;
    color: #0f172a;
    font-size: 12px;
    font-weight: 600;
  }

  .ip-drawer-pill-muted {
    background: #e2e8f0;
  }

  .ip-drawer-close {
    border: none;
    background: none;
    font-size: 18px;
    cursor: pointer;
  }

  .ip-drawer-body {
    flex: 1;
    overflow-y: auto;
    padding: 16px 24px;
  }

  .ip-drawer-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .ip-drawer-section {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .ip-drawer-section h3 {
    margin: 0;
    font-size: 14px;
    color: #475569;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .ip-drawer-row {
    display: grid;
    gap: 12px;
  }

  .ip-drawer-row-two {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .ip-drawer-auto-host {
    display: none;
    margin-top: 10px;
    gap: 6px;
    flex-direction: column;
    align-items: flex-start;
  }

  .ip-drawer-auto-host.is-visible {
    display: flex;
  }

  .ip-drawer-helper {
    margin: 0;
    font-size: 12px;
    color: #64748b;
  }

  .ip-drawer-helper-error {
    color: #dc2626;
  }

  .ip-drawer-footer {
    padding: 16px 24px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
  }

  .ip-drawer-footer-status {
    color: #64748b;
    font-size: 13px;
  }

  .ip-drawer-footer-actions {
    display: flex;
    gap: 12px;
  }


  .field-tag-filter .select[multiple] {
    min-height: 40px;
    height: 40px;
    overflow-y: auto;
  }

  .tag-filter-controls {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .tag-filter-controls .select {
    flex: 1;
  }

  @media (max-width: 600px) {
    .ip-drawer-row-two {
      grid-template-columns: 1fr;
    }

    .ip-drawer-footer {
      flex-direction: column;
      align-items: flex-end;
    }
  }
</style>

<script>
  (() => {
    const GLOBAL_FLAG = 'ipocketIpAssetsInitialized';
    const SCROLL_KEY = 'ipocket.ip-assets.scrollY';
    const overlay = document.querySelector('[data-ip-drawer-overlay]');
    const drawer = document.querySelector('[data-ip-drawer]');
    const drawerSubtitle = document.querySelector('[data-ip-drawer-subtitle]');
    const closeButton = document.querySelector('[data-ip-drawer-close]');
    const cancelButton = document.querySelector('[data-ip-drawer-cancel]');
    const saveButton = document.querySelector('[data-ip-drawer-save]');
    const form = document.querySelector('[data-ip-edit-form]');
    const projectPill = document.querySelector('[data-ip-drawer-project]');
    const hostPill = document.querySelector('[data-ip-drawer-host]');
    const dirtyStatus = document.querySelector('[data-ip-drawer-dirty]');
    const autoHostWrapper = document.querySelector('[data-ip-auto-host]');
    const autoHostButton = document.querySelector('[data-ip-auto-host-button]');
    const autoHostName = document.querySelector('[data-ip-auto-host-name]');
    const autoHostStatus = document.querySelector('[data-ip-auto-host-status]');
    const inputs = form ? form.querySelectorAll('[data-ip-input]') : [];
    const filterForm = document.querySelector('.filters-grid');
    const hostField = form ? form.querySelector('[data-ip-host-field]') : null;
    let initialValues = {};
    let currentAsset = null;
    let isOpen = false;

    const shouldShowHostField = (typeValue) => ['OS', 'BMC'].includes((typeValue || '').toUpperCase());
    const shouldShowAutoHost = (typeValue, hostValue) =>
      (typeValue || '').toUpperCase() === 'BMC' && !(hostValue || '').trim();

    const updateHostVisibility = () => {
      if (!hostField || !form) {
        return;
      }
      const typeInput = form.querySelector('[data-ip-input="type"]');
      const typeValue = typeInput ? typeInput.value : '';
      const showHost = shouldShowHostField(typeValue);
      hostField.style.display = showHost ? '' : 'none';
      if (!showHost) {
        const hostSelect = form.querySelector('[data-ip-input="host_id"]');
        if (hostSelect) {
          hostSelect.value = '';
        }
      }
      updateAutoHostVisibility();
    };

    const updateAutoHostVisibility = () => {
      if (!autoHostWrapper || !form) {
        return;
      }
      const typeInput = form.querySelector('[data-ip-input="type"]');
      const hostSelect = form.querySelector('[data-ip-input="host_id"]');
      const typeValue = typeInput ? typeInput.value : '';
      const hostValue = hostSelect ? hostSelect.value : '';
      const showAutoHost = shouldShowAutoHost(typeValue, hostValue);
      autoHostWrapper.classList.toggle('is-visible', showAutoHost);
      if (autoHostStatus) {
        autoHostStatus.textContent = '';
      }
    };

    const updateSaveState = () => {
      if (!dirtyStatus || !saveButton) {
        return;
      }
      const dirty = Array.from(inputs).some((input) => {
        const key = input.dataset.ipInput;
        return (input.value || '').trim() !== (initialValues[key] || '');
      });
      saveButton.disabled = !dirty;
      dirtyStatus.textContent = dirty ? 'Unsaved changes' : 'No changes';
    };

    const openDrawer = (assetData) => {
      if (!overlay || !drawer || !form || !drawerSubtitle || !projectPill || !hostPill) {
        return;
      }
      currentAsset = assetData;
      inputs.forEach((input) => {
        const key = input.dataset.ipInput;
        input.value = assetData[key] || '';
      });
      form.action = `/ui/ip-assets/${assetData.id}/edit`;
      drawerSubtitle.textContent = assetData.ip_address || '—';
      projectPill.textContent = `Project: ${assetData.project_label || 'Unassigned'}`;
      hostPill.textContent = `Host: ${assetData.host_label || '—'}`;
      updateHostVisibility();
      initialValues = {
        ip_address: assetData.ip_address || '',
        type: assetData.type || '',
        project_id: assetData.project_id || '',
        host_id: assetData.host_id || '',
        tags: assetData.tags || '',
        notes: assetData.notes || '',
      };
      updateSaveState();
      overlay.classList.add('is-open');
      drawer.classList.add('is-open');
      isOpen = true;
      if (autoHostName) {
        autoHostName.textContent = `server_${assetData.ip_address || 'IP'}`;
      }
      if (autoHostButton) {
        autoHostButton.disabled = false;
      }
      if (autoHostStatus) {
        autoHostStatus.textContent = '';
      }
    };

    const closeDrawer = () => {
      if (!overlay || !drawer) {
        return;
      }
      overlay.classList.remove('is-open');
      drawer.classList.remove('is-open');
      isOpen = false;
    };

    const confirmClose = () => {
      const dirty = Array.from(inputs).some((input) => {
        const key = input.dataset.ipInput;
        return (input.value || '').trim() !== (initialValues[key] || '');
      });
      if (!dirty) {
        closeDrawer();
        return;
      }
      if (window.confirm('Discard changes?')) {
        closeDrawer();
      }
    };

    const bindEditButtons = (root = document) => {
      const editButtons = root.querySelectorAll('[data-ip-edit]');
      editButtons.forEach((button) => {
        if (button.dataset.ipEditBound) {
          return;
        }
        button.dataset.ipEditBound = 'true';
        button.addEventListener('click', () => {
          const assetData = {
            id: button.dataset.ipEdit,
            ip_address: button.dataset.ipAddress || '',
            type: button.dataset.ipType || '',
            project_id: button.dataset.ipProjectId || '',
            project_label: button.dataset.ipProjectName || 'Unassigned',
            host_id: button.dataset.ipHostId || '',
            host_label: button.dataset.ipHostName || '—',
            notes: button.dataset.ipNotes || '',
            tags: button.dataset.ipTags || '',
          };
          openDrawer(assetData);
        });
      });
    };

    const bindDeleteDialogs = (root = document) => {
      const openButtons = root.querySelectorAll('[data-delete-dialog-id]');
      openButtons.forEach((button) => {
        if (button.dataset.deleteDialogBound) {
          return;
        }
        button.dataset.deleteDialogBound = 'true';
        button.addEventListener('click', () => {
          const dialog = document.getElementById(button.dataset.deleteDialogId);
          if (dialog && typeof dialog.showModal === 'function') {
            dialog.showModal();
          }
        });
      });

      const closeButtons = root.querySelectorAll('[data-close-delete-dialog]');
      closeButtons.forEach((button) => {
        if (button.dataset.closeDialogBound) {
          return;
        }
        button.dataset.closeDialogBound = 'true';
        button.addEventListener('click', () => {
          const dialog = button.closest('dialog');
          if (dialog) {
            dialog.close();
          }
        });
      });
    };

    const bindBulkEdit = (root = document) => {
      const bulkForm = root.querySelector('[data-bulk-form]');
      if (!bulkForm || bulkForm.dataset.bulkBound) {
        return;
      }
      bulkForm.dataset.bulkBound = 'true';
      const selectAll = bulkForm.querySelector('[data-bulk-select-all]');
      const checkboxes = Array.from(bulkForm.querySelectorAll('[data-bulk-select]'));
      const countLabel = bulkForm.querySelector('[data-selected-count]');
      const submitButton = bulkForm.querySelector('[data-bulk-submit]');
      const bulkControls = bulkForm.querySelector('[data-bulk-controls]');

      const updateCount = () => {
        const selectedCount = checkboxes.filter((checkbox) => checkbox.checked).length;
        if (countLabel) {
          countLabel.textContent = `${selectedCount} selected`;
        }
        if (submitButton) {
          submitButton.disabled = selectedCount === 0;
        }
        if (bulkControls) {
          bulkControls.classList.toggle('bulk-edit-controls-hidden', selectedCount === 0);
        }
        if (selectAll) {
          selectAll.indeterminate = selectedCount > 0 && selectedCount < checkboxes.length;
          selectAll.checked = selectedCount > 0 && selectedCount === checkboxes.length;
        }
      };

      if (selectAll) {
        selectAll.addEventListener('change', () => {
          const shouldCheck = selectAll.checked;
          checkboxes.forEach((checkbox) => {
            checkbox.checked = shouldCheck;
          });
          updateCount();
        });
      }

      checkboxes.forEach((checkbox) => {
        checkbox.addEventListener('change', () => {
          updateCount();
        });
      });

      updateCount();
    };

    const applyQuickFilter = (fieldName, value) => {
      if (!filterForm) {
        return;
      }
      const filterInput = filterForm.querySelector(`[name="${fieldName}"]`);
      if (!filterInput) {
        return;
      }
      if (fieldName === 'tag' && filterInput.tagName === 'SELECT' && filterInput.multiple) {
        const options = Array.from(filterInput.options);
        const target = options.find((option) => option.value === value);
        if (target) {
          target.selected = !target.selected;
        }
      } else {
        filterInput.value = value || '';
      }
      if (window.htmx && typeof window.htmx.trigger === 'function') {
        window.htmx.trigger(filterInput, 'change');
        return;
      }
      filterForm.submit();
    };

    const clearTagFilter = () => {
      if (!filterForm) {
        return;
      }
      const tagFilter = filterForm.querySelector('[name="tag"]');
      if (!tagFilter || tagFilter.tagName !== 'SELECT') {
        return;
      }
      Array.from(tagFilter.options).forEach((option) => {
        option.selected = false;
      });
      if (window.htmx && typeof window.htmx.trigger === 'function') {
        window.htmx.trigger(tagFilter, 'change');
        return;
      }
      filterForm.submit();
    };

    const createAutoHost = async () => {
      if (!currentAsset || !form || !autoHostButton) {
        return;
      }
      autoHostButton.disabled = true;
      if (autoHostStatus) {
        autoHostStatus.textContent = '';
      }
      try {
        const response = await fetch(`/ui/ip-assets/${currentAsset.id}/auto-host`, {
          method: 'POST',
          headers: {
            Accept: 'application/json',
          },
        });
        let payload = {};
        try {
          payload = await response.json();
        } catch (error) {
          payload = {};
        }
        if (!response.ok) {
          throw new Error(payload.error || 'Unable to create host.');
        }
        const hostSelect = form.querySelector('[data-ip-input="host_id"]');
        if (hostSelect) {
          const hostId = String(payload.host_id);
          let option = Array.from(hostSelect.options).find((entry) => entry.value === hostId);
          if (!option) {
            option = document.createElement('option');
            option.value = hostId;
            option.textContent = payload.host_name || `Host ${hostId}`;
            hostSelect.appendChild(option);
          }
          hostSelect.value = hostId;
        }
        if (hostPill) {
          hostPill.textContent = `Host: ${payload.host_name || '—'}`;
        }
        updateSaveState();
        updateAutoHostVisibility();
      } catch (error) {
        if (autoHostStatus) {
          autoHostStatus.textContent = error.message;
        }
      } finally {
        autoHostButton.disabled = false;
      }
    };

    if (!window[GLOBAL_FLAG]) {
      window[GLOBAL_FLAG] = true;
      if (typeof window !== 'undefined' && window.sessionStorage) {
        const storedScroll = window.sessionStorage.getItem(SCROLL_KEY);
        if (storedScroll) {
          window.scrollTo(0, Number.parseInt(storedScroll, 10) || 0);
          window.sessionStorage.removeItem(SCROLL_KEY);
        }
      }
      if (closeButton) {
        closeButton.addEventListener('click', confirmClose);
      }
      if (cancelButton) {
        cancelButton.addEventListener('click', confirmClose);
      }
      if (overlay) {
        overlay.addEventListener('click', confirmClose);
      }
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && isOpen) {
          confirmClose();
        }
      });
      inputs.forEach((input) => {
        input.addEventListener('input', () => {
          if (input.dataset.ipInput === 'type') {
            updateHostVisibility();
          }
          if (input.dataset.ipInput === 'host_id') {
            updateAutoHostVisibility();
          }
          updateSaveState();
        });
      });
      if (autoHostButton) {
        autoHostButton.addEventListener('click', createAutoHost);
      }
      updateHostVisibility();
      if (form && window.sessionStorage) {
        form.addEventListener('submit', () => {
          window.sessionStorage.setItem(SCROLL_KEY, String(window.scrollY || 0));
        });
      }
      const clearTagButton = document.querySelector('[data-clear-tag-filter]');
      if (clearTagButton) {
        clearTagButton.addEventListener('click', clearTagFilter);
      }

      document.body.addEventListener('htmx:afterSwap', (event) => {
        if (event.target && event.target.id === 'ip-table-container') {
          bindEditButtons(event.target);
          bindDeleteDialogs(event.target);
          bindBulkEdit(event.target);
        }
      });
      document.body.addEventListener('click', (event) => {
        const trigger = event.target.closest('[data-quick-filter]');
        if (!trigger) {
          return;
        }
        event.preventDefault();
        applyQuickFilter(trigger.dataset.quickFilter, trigger.dataset.quickFilterValue || '');
      });
    }

    bindEditButtons();
    bindDeleteDialogs();
    bindBulkEdit();
  })();
</script>
{% endblock %}
