{% extends "base.html" %}

{% block content %}
<section class="page-header">
  <div>
    <p class="eyebrow">Inventory</p>
    <h1>IP Assets</h1>
    <p class="subtitle">Manage and monitor network address assignments across all zones.</p>
  </div>
  <div class="header-actions">
    <button class="btn btn-primary" type="button" data-ip-add>Add IP</button>
  </div>
</section>
<section class="card filter-card">
  <form class="filters-grid" method="get" action="/ui/ip-assets">
    <label class="field">
      <span>Search</span>
      <input
        class="input"
        type="text"
        name="q"
        value="{{ filters.q }}"
        placeholder="IP or notes"
        hx-get="/ui/ip-assets"
        hx-trigger="keyup changed delay:500ms, search"
        hx-target="#ip-table-container"
        hx-push-url="true"
        hx-include="closest form"
      />
    </label>
    <label class="field">
      <span>Project</span>
      <select
        class="select"
        name="project_id"
        hx-get="/ui/ip-assets"
        hx-trigger="change"
        hx-target="#ip-table-container"
        hx-push-url="true"
        hx-include="closest form"
      >
        <option value=""{% if filters.project_filter == "" %} selected{% endif %}>All</option>
        <option value="unassigned"{% if filters.project_filter == "unassigned" %} selected{% endif %}>Unassigned</option>
        {% for project in projects %}
        <option value="{{ project.id }}"{% if filters.project_filter == (project.id ~ "") %} selected{% endif %}>{{ project.name }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="field">
      <span>Type</span>
      <select
        class="select"
        name="type"
        hx-get="/ui/ip-assets"
        hx-trigger="change"
        hx-target="#ip-table-container"
        hx-push-url="true"
        hx-include="closest form"
      >
        <option value="">All</option>
        {% for asset_type in types %}
        <option value="{{ asset_type }}"{% if filters.type == asset_type %} selected{% endif %}>{{ asset_type }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="field">
      <span>Assignment</span>
      <select
        class="select"
        name="unassigned-only"
        hx-get="/ui/ip-assets"
        hx-trigger="change"
        hx-target="#ip-table-container"
        hx-push-url="true"
        hx-include="closest form"
      >
        <option value="false"{% if not filters.unassigned_only %} selected{% endif %}>All</option>
        <option value="true"{% if filters.unassigned_only %} selected{% endif %}>Unassigned only</option>
      </select>
    </label>
    <label class="field">
      <span>Status</span>
      <select
        class="select"
        name="archived-only"
        hx-get="/ui/ip-assets"
        hx-trigger="change"
        hx-target="#ip-table-container"
        hx-push-url="true"
        hx-include="closest form"
      >
        <option value="false"{% if not filters.archived_only %} selected{% endif %}>Active only</option>
        <option value="true"{% if filters.archived_only %} selected{% endif %}>Archived only</option>
      </select>
    </label>
    <label class="field field-tag-filter">
      <span>Tags</span>
      <div class="tag-filter-controls">
        <input
          class="input"
          type="text"
          placeholder="Type tag and press Enter"
          list="tag-filter-suggestions"
          data-tag-filter-input
        />
      </div>
      <datalist id="tag-filter-suggestions">
        {% for tag in tags %}
        <option value="{{ tag.name }}"></option>
        {% endfor %}
      </datalist>
      <div class="tag-filter-selected" data-tag-filter-selected>
        {% for selected_tag in filters.tag %}
        <span class="tag-filter-entry" data-tag-filter-entry="{{ selected_tag }}">
          <input type="hidden" name="tag" value="{{ selected_tag }}" />
          <button class="tag tag-color tag-filter-chip" type="button" data-remove-tag-filter="{{ selected_tag }}">{{ selected_tag }} ×</button>
        </span>
        {% endfor %}
      </div>
    </label>
  </form>
</section>

<div id="ip-table-container">
  {% include "partials/ip_assets_table.html" %}
</div>

<div class="ip-drawer-overlay" data-ip-drawer-overlay aria-hidden="true"></div>
<aside class="ip-drawer" data-ip-drawer data-ip-drawer-mode="edit" role="dialog" aria-modal="true" aria-label="Edit IP asset">
  <div class="ip-drawer-header">
    <div class="ip-drawer-header-row">
      <div>
        <h2 class="ip-drawer-title" data-ip-drawer-title>Edit IP asset</h2>
        <p class="ip-drawer-subtitle" data-ip-drawer-subtitle>—</p>
      </div>
      <button class="ip-drawer-close" type="button" aria-label="Close drawer" data-ip-drawer-close>
        ✕
      </button>
    </div>
    <div class="ip-drawer-meta">
      <span class="ip-drawer-pill" data-ip-drawer-project>Project: Unassigned</span>
      <span class="ip-drawer-pill ip-drawer-pill-muted" data-ip-drawer-host>Host: —</span>
    </div>
  </div>
  <div class="ip-drawer-body">
    <form class="ip-drawer-form" method="post" data-ip-edit-form data-ip-mode-panel="edit" id="ip-edit-form">
      <input type="hidden" name="return_to" value="{{ return_to }}">
      <section class="ip-drawer-section">
        <h3>Assignment</h3>
        <label class="field">
          <span>IP address</span>
          <input class="input" type="text" name="ip_address" data-ip-input="ip_address" />
        </label>
        <div class="ip-drawer-row ip-drawer-row-two">
          <label class="field">
            <span>Type</span>
            <select class="select" name="type" data-ip-input="type">
              {% for asset_type in types %}
              <option value="{{ asset_type }}">{{ asset_type }}</option>
              {% endfor %}
            </select>
          </label>
          <label class="field">
            <span>Project</span>
            <select class="select" name="project_id" data-ip-input="project_id">
              <option value="">Unassigned</option>
              {% for project in projects %}
              <option value="{{ project.id }}">{{ project.name }}</option>
              {% endfor %}
            </select>
          </label>
        </div>
        <label class="field" data-ip-host-field>
          <span>Host</span>
          <select class="select" name="host_id" data-ip-input="host_id">
            <option value="">Unassigned</option>
            {% for host in hosts %}
            <option value="{{ host.id }}">{{ host.name }}</option>
            {% endfor %}
          </select>
        </label>
        <div class="ip-drawer-auto-host" data-ip-auto-host>
          <button class="btn btn-outline btn-small" type="button" data-ip-auto-host-button>
            Create host
          </button>
          <p class="ip-drawer-helper" data-ip-auto-host-hint>
            Creates and assigns a host named <span class="mono" data-ip-auto-host-name>server_IP</span>.
          </p>
          <p class="ip-drawer-helper ip-drawer-helper-error" data-ip-auto-host-status></p>
        </div>
      </section>
      <section class="ip-drawer-section">
        <h3>Notes & tags</h3>
        <label class="field">
          <span>Tags</span>
          <select class="select" name="tags" data-ip-input="tags" multiple size="6" data-tag-picker data-tag-picker-placeholder="Add tags...">
            {% for tag in tags %}
            <option value="{{ tag.name }}" data-tag-color="{{ tag.color }}">{{ tag.name }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="field">
          <span>Notes</span>
          <textarea class="textarea" name="notes" rows="3" data-ip-input="notes"></textarea>
        </label>
      </section>
    </form>

    <form class="ip-drawer-form ip-drawer-delete-form" method="post" data-ip-delete-form data-ip-mode-panel="delete" id="ip-delete-form" hidden>
      <input type="hidden" name="return_to" value="{{ return_to }}" data-ip-delete-return-to>
      <section class="ip-drawer-section">
        <h3 class="ip-drawer-delete-heading">Delete IP asset?</h3>
        <p class="ip-drawer-delete-warning">Permanent and cannot be undone.</p>
        <dl class="ip-drawer-delete-details">
          <div><dt>IP address</dt><dd class="mono" data-ip-delete-address>—</dd></div>
          <div><dt>Project</dt><dd data-ip-delete-project>—</dd></div>
          <div><dt>Type</dt><dd data-ip-delete-type>—</dd></div>
          <div><dt>Host</dt><dd data-ip-delete-host>—</dd></div>
        </dl>
        <label class="field field-inline">
          <input class="checkbox" type="checkbox" name="confirm_delete_ack" data-ip-delete-ack />
          <span>I understand this cannot be undone</span>
        </label>
        <label class="field" data-ip-delete-confirm-wrap hidden>
          <span>High-risk asset: type the exact IP to confirm</span>
          <input class="input" type="text" name="confirm_ip" data-ip-delete-confirm-input autocomplete="off" />
        </label>
        <p class="ip-drawer-helper ip-drawer-helper-error" data-ip-delete-error></p>
      </section>
    </form>
  </div>
  <div class="ip-drawer-footer">
    <span class="ip-drawer-footer-status" data-ip-drawer-dirty>No changes</span>
    <div class="ip-drawer-footer-actions">
      <button class="btn btn-secondary" type="button" data-ip-drawer-cancel>Cancel</button>
      <button class="btn btn-primary" type="submit" form="ip-edit-form" data-ip-drawer-save data-ip-mode-action="edit" disabled>
        Save changes
      </button>
      <button class="btn btn-danger" type="submit" form="ip-delete-form" data-ip-drawer-delete data-ip-mode-action="delete" hidden disabled>
        Delete permanently
      </button>
    </div>
  </div>
</aside>

<script src="/static/js/ip-assets.js" defer></script>
{% endblock %}
