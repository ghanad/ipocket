{% extends "base.html" %}

{% block content %}
<section class="page-header">
  <div>
    <h1>{{ ip_range.name }}</h1>
    <p class="subtitle">CIDR {{ ip_range.cidr }} • {{ used_total }} used • {{ free_total }} free</p>
  </div>
  <div class="page-actions">
    <a class="btn btn-secondary" href="/ui/ranges">Back to ranges</a>
  </div>
</section>

{% if errors %}
<div class="alert alert-error">
  <p class="alert-title">Fix the following:</p>
  <ul>
    {% for error in errors %}
    <li>{{ error }}</li>
    {% endfor %}
  </ul>
</div>
{% endif %}

<section class="card">
  <div class="card-header">
    <div>
      <h2>Range details</h2>
      <p class="subtitle">Usable total: {{ total_usable }} (excludes network/broadcast for /30 and larger ranges).</p>
    </div>
  </div>
  <div class="card-body">
    <p class="muted">Click the Used or Free counts on the utilization tables to return here.</p>
  </div>
</section>

<section class="card table-card" id="addresses">
  <div class="card-header card-header-padded">
    <div>
      <h2>Addresses in this range</h2>
      <p class="subtitle">Used: {{ used_total }} • Free: {{ free_total }}</p>
    </div>
  </div>
  <div class="table-wrapper">
    <table class="table">
      <thead>
        <tr>
          <th>IP address</th>
          <th>Status</th>
          <th>Project</th>
          <th>Type</th>
          <th>Host Pair</th>
          <th>Tags</th>
          <th>Notes</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for entry in address_display %}
        <tr id="ip-{{ entry.ip_address | replace('.', '-') | replace(':', '-') }}">
          <td class="mono">
            {% if entry.asset_id %}
            <a class="link" href="/ui/ip-assets/{{ entry.asset_id }}">{{ entry.ip_address }}</a>
            {% else %}
            {{ entry.ip_address }}
            {% endif %}
          </td>
          <td>
            {% if entry.status == "used" %}
            <span class="pill pill-danger">Used</span>
            {% else %}
            <span class="pill pill-success">Free</span>
            {% endif %}
          </td>
          <td>
            {% if entry.status == "used" and entry.project_unassigned %}
            <span class="tag tag-warning">Unassigned</span>
            {% elif entry.status == "used" %}
            <span class="tag tag-project" style="--project-color: {{ entry.project_color }}">{{ entry.project_name }}</span>
            {% else %}
            <span class="muted">—</span>
            {% endif %}
          </td>
          <td class="muted">
            {% if entry.status == "used" %}
            {{ entry.asset_type }}
            {% else %}
            —
            {% endif %}
          </td>
          <td>
            {% if entry.status == "used" and entry.host_pair %}
            <span class="mono">{{ entry.host_pair }}</span>
            {% else %}
            <span class="muted">—</span>
            {% endif %}
          </td>
          <td>
            {% if entry.status == "used" and entry.tags %}
            {% for tag in entry.tags %}
            <span class="tag tag-color" style="--tag-color: {{ tag.color }}">{{ tag.name }}</span>
            {% endfor %}
            {% else %}
            <span class="muted">—</span>
            {% endif %}
          </td>
          <td class="muted">
            {% if entry.status == "used" and entry.notes %}
            {{ entry.notes }}
            {% else %}
            —
            {% endif %}
          </td>
          <td>
            {% if entry.status == "free" %}
            <button
              class="btn btn-secondary btn-small"
              type="button"
              data-range-address-add
              data-ip-address="{{ entry.ip_address }}"
            >
              Add…
            </button>
            {% elif entry.asset_id %}
            <button
              class="btn btn-secondary btn-small"
              type="button"
              data-range-address-edit
              data-asset-id="{{ entry.asset_id }}"
              data-ip-address="{{ entry.ip_address }}"
              data-type="{{ entry.asset_type }}"
              data-project-id="{{ entry.project_id or '' }}"
              data-project-name="{{ entry.project_name or '' }}"
              data-notes="{{ entry.notes }}"
              data-tags="{% if entry.tags %}{% for tag in entry.tags %}{{ tag.name }}{% if not loop.last %}, {% endif %}{% endfor %}{% endif %}"
            >
              Edit
            </button>
            {% else %}
            <span class="muted">—</span>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="8" class="empty-state">No addresses in this range.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% if address_overflow %}
  <p class="table-footer muted">Showing first {{ display_limit }} of {{ used_total + free_total }} addresses.</p>
  {% endif %}
</section>

<div class="ip-drawer-overlay" data-range-drawer-overlay aria-hidden="true"></div>
<aside class="ip-drawer" data-range-drawer role="dialog" aria-modal="true" aria-label="Manage range address">
  <div class="ip-drawer-header">
    <div class="ip-drawer-header-row">
      <div>
        <h2 class="ip-drawer-title" data-range-drawer-title>Add IP asset</h2>
        <p class="ip-drawer-subtitle" data-range-drawer-subtitle>—</p>
      </div>
      <button class="ip-drawer-close" type="button" data-range-drawer-close aria-label="Close drawer">✕</button>
    </div>
  </div>
  <div class="ip-drawer-body">
    <form class="ip-drawer-form" method="post" data-range-drawer-form id="range-address-form">
      <input type="hidden" name="ip_address" data-range-input="ip_address" />
      <section class="ip-drawer-section">
        <h3>Assignment</h3>
        <label class="field">
          <span>IP address</span>
          <input class="input" type="text" readonly data-range-input="ip_display" />
        </label>
        <div class="ip-drawer-row ip-drawer-row-two">
          <label class="field">
            <span>Type</span>
            <select class="select" name="type" data-range-input="type">
              {% for asset_type in types %}
              <option value="{{ asset_type }}">{{ asset_type }}</option>
              {% endfor %}
            </select>
          </label>
          <label class="field">
            <span>Project</span>
            <select class="select" name="project_id" data-range-input="project_id">
              <option value="">Unassigned</option>
              {% for project in projects %}
              <option value="{{ project.id }}">{{ project.name }}</option>
              {% endfor %}
            </select>
          </label>
        </div>
      </section>
      <section class="ip-drawer-section">
        <h3>Notes & tags</h3>
        <label class="field">
          <span>Tags</span>
          <input class="input" type="text" name="tags" placeholder="comma,separated" data-range-input="tags" />
        </label>
        <label class="field">
          <span>Notes</span>
          <textarea class="textarea" name="notes" rows="3" data-range-input="notes"></textarea>
        </label>
      </section>
    </form>
  </div>
  <div class="ip-drawer-footer">
    <span class="ip-drawer-footer-status" data-range-drawer-status>No changes</span>
    <div class="ip-drawer-footer-actions">
      <button class="btn btn-secondary" type="button" data-range-drawer-cancel>Cancel</button>
      <button class="btn btn-primary" type="submit" form="range-address-form" data-range-drawer-save disabled>Save</button>
    </div>
  </div>
</aside>

<script src="/static/js/range-addresses.js" defer></script>
{% endblock %}
