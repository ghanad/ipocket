{% extends "base.html" %}

{% block content %}
<section class="page-header">
  <div>
    <h1>IP Ranges</h1>
    <p class="page-subtitle">Define CIDR ranges and review utilization across active IP assets.</p>
  </div>
  <div class="page-header-actions">
    <button class="btn btn-primary" type="button" data-range-add>New Range</button>
  </div>
</section>

<section class="card table-card">
  <div class="card-header card-header-padded">
    <div>
      <h2>IP Ranges</h2>
      <p class="subtitle">Click used or free to review addresses within each range.</p>
    </div>
  </div>
  <div class="table-wrapper">
    <table class="table">
      <thead>
        <tr>
          <th>Name</th>
          <th>CIDR</th>
          <th>Total usable</th>
          <th>Used</th>
          <th>Free</th>
          <th>Utilization</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for row in range_rows %}
        <tr>
          <td>{{ row.name }}</td>
          <td>{{ row.cidr }}</td>
          <td>{{ row.total_usable if row.total_usable is not none else "—" }}</td>
          <td>{% if row.used is not none %}<a class="link" href="/ui/ranges/{{ row.id }}/addresses#used">{{ row.used }}</a>{% else %}—{% endif %}</td>
          <td>{% if row.free is not none %}<a class="link" href="/ui/ranges/{{ row.id }}/addresses#free">{{ row.free }}</a>{% else %}—{% endif %}</td>
          <td>{% if row.utilization_percent is not none %}{{ "%.1f"|format(row.utilization_percent) }}%{% else %}—{% endif %}</td>
          <td class="asset-actions-cell">
            <div class="table-actions">
              <button
                class="btn btn-secondary btn-small"
                type="button"
                data-range-edit="{{ row.id }}"
                data-range-name="{{ row.name }}"
                data-range-cidr="{{ row.cidr }}"
                data-range-notes="{{ row.notes or '' }}"
              >
                Edit
              </button>
              <button
                class="btn btn-danger btn-small"
                type="button"
                data-range-delete="{{ row.id }}"
                data-range-delete-name="{{ row.name }}"
                data-range-delete-cidr="{{ row.cidr }}"
                data-range-delete-used="{{ row.used if row.used is not none else '—' }}"
              >
                Delete
              </button>
            </div>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="7" class="empty-state">No ranges yet. Add ranges to see utilization.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
<div class="ip-drawer-overlay" data-range-create-overlay aria-hidden="true"></div>
<aside class="ip-drawer" data-range-create-drawer data-range-open="{{ 'true' if errors else 'false' }}" role="dialog" aria-modal="true" aria-label="Add IP range">
  <div class="ip-drawer-header">
    <div class="ip-drawer-header-row">
      <div>
        <h2 class="ip-drawer-title">Add IP Range</h2>
        <p class="ip-drawer-subtitle">Use CIDR notation to group ranges for reporting.</p>
      </div>
      <button class="ip-drawer-close" type="button" aria-label="Close drawer" data-range-create-close>✕</button>
    </div>
  </div>
  <div class="ip-drawer-body">
    {% if errors %}
    <div class="alert alert-error">
      <ul>
        {% for error in errors %}
        <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
    <form class="ip-drawer-form" method="post" action="/ui/ranges" data-range-create-form id="range-create-form">
      <section class="ip-drawer-section">
        <h3>Range details</h3>
        <label class="field">
          <span>Name</span>
          <input class="input" type="text" name="name" value="{{ form_state.name }}" data-range-input="name" required />
        </label>
        <label class="field">
          <span>CIDR</span>
          <input class="input" type="text" name="cidr" value="{{ form_state.cidr }}" placeholder="192.168.10.0/24" data-range-input="cidr" required />
        </label>
        <label class="field">
          <span>Notes</span>
          <textarea class="textarea" name="notes" rows="3" data-range-input="notes">{{ form_state.notes }}</textarea>
        </label>
      </section>
    </form>
  </div>
  <div class="ip-drawer-footer">
    <span class="ip-drawer-footer-status" data-range-create-dirty>Enter details</span>
    <div class="ip-drawer-footer-actions">
      <button class="btn btn-secondary" type="button" data-range-create-cancel>Cancel</button>
      <button class="btn btn-primary" type="submit" form="range-create-form" data-range-create-save disabled>Save range</button>
    </div>
  </div>
</aside>

<div class="ip-drawer-overlay" data-range-edit-overlay aria-hidden="true"></div>
<aside class="ip-drawer" data-range-edit-drawer data-range-edit-open="{{ 'true' if (edit_errors or edit_ip_range) else 'false' }}" role="dialog" aria-modal="true" aria-label="Edit IP range">
  <div class="ip-drawer-header">
    <div class="ip-drawer-header-row">
      <div>
        <h2 class="ip-drawer-title">Edit IP Range</h2>
        <p class="ip-drawer-subtitle">Update the CIDR definition and notes for this range.</p>
      </div>
      <button class="ip-drawer-close" type="button" aria-label="Close drawer" data-range-edit-close>✕</button>
    </div>
  </div>
  <div class="ip-drawer-body">
    {% if edit_errors %}
    <div class="alert alert-error">
      <ul>
        {% for error in edit_errors %}
        <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
    <form
      class="ip-drawer-form"
      method="post"
      action="{% if edit_ip_range %}/ui/ranges/{{ edit_ip_range.id }}/edit{% else %}#{% endif %}"
      data-range-edit-form
      id="range-edit-form"
      data-range-edit-id="{{ edit_ip_range.id if edit_ip_range else '' }}"
    >
      <section class="ip-drawer-section">
        <h3>Range details</h3>
        <label class="field">
          <span>Name</span>
          <input class="input" type="text" name="name" value="{{ edit_form_state.name }}" data-range-edit-input="name" required />
        </label>
        <label class="field">
          <span>CIDR</span>
          <input class="input" type="text" name="cidr" value="{{ edit_form_state.cidr }}" placeholder="192.168.10.0/24" data-range-edit-input="cidr" required />
        </label>
        <label class="field">
          <span>Notes</span>
          <textarea class="textarea" name="notes" rows="3" data-range-edit-input="notes">{{ edit_form_state.notes }}</textarea>
        </label>
      </section>
    </form>
  </div>
  <div class="ip-drawer-footer">
    <span class="ip-drawer-footer-status" data-range-edit-dirty>Choose range</span>
    <div class="ip-drawer-footer-actions">
      <button class="btn btn-secondary" type="button" data-range-edit-cancel>Cancel</button>
      <button class="btn btn-primary" type="submit" form="range-edit-form" data-range-edit-save disabled>Save changes</button>
    </div>
  </div>
</aside>

<div class="ip-drawer-overlay" data-range-delete-overlay aria-hidden="true"></div>
<aside class="ip-drawer" data-range-delete-drawer data-range-delete-open="{{ 'true' if delete_ip_range else 'false' }}" role="dialog" aria-modal="true" aria-label="Delete IP range">
  <div class="ip-drawer-header">
    <div class="ip-drawer-header-row">
      <div>
        <h2 class="ip-drawer-title">Delete IP Range</h2>
        <p class="ip-drawer-subtitle" data-range-delete-subtitle>Permanent removal</p>
      </div>
      <button class="ip-drawer-close" type="button" aria-label="Close drawer" data-range-delete-close>✕</button>
    </div>
  </div>
  <div class="ip-drawer-body">
    {% if delete_errors %}
    <div class="alert alert-error">
      <ul>
        {% for error in delete_errors %}
        <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
    <form
      class="ip-drawer-form ip-drawer-delete-form"
      method="post"
      action="{% if delete_ip_range %}/ui/ranges/{{ delete_ip_range.id }}/delete{% else %}#{% endif %}"
      data-range-delete-form
      id="range-delete-form"
      data-range-delete-id="{{ delete_ip_range.id if delete_ip_range else '' }}"
      data-range-delete-name="{{ delete_ip_range.name if delete_ip_range else '' }}"
    >
      <section class="ip-drawer-section">
        <h3 class="ip-drawer-delete-heading">Delete this range?</h3>
        <p class="ip-drawer-delete-warning">This action permanently removes the range.</p>
        <dl class="ip-drawer-delete-details">
          <div><dt>Name</dt><dd data-range-delete-name-display>{{ delete_ip_range.name if delete_ip_range else '—' }}</dd></div>
          <div><dt>CIDR</dt><dd class="mono" data-range-delete-cidr>{{ delete_ip_range.cidr if delete_ip_range else '—' }}</dd></div>
          <div><dt>Used addresses</dt><dd data-range-delete-used>—</dd></div>
        </dl>
        <label class="field field-inline">
          <input class="checkbox" type="checkbox" data-range-delete-ack />
          <span>I understand this cannot be undone</span>
        </label>
        <label class="field">
          <span>Type the range name to confirm: <strong data-range-delete-name-inline>{{ delete_ip_range.name if delete_ip_range else '—' }}</strong></span>
          <input
            class="input"
            type="text"
            name="confirm_name"
            autocomplete="off"
            data-range-delete-confirm
            value="{{ delete_confirm_value }}"
          />
        </label>
      </section>
    </form>
  </div>
  <div class="ip-drawer-footer">
    <span class="ip-drawer-footer-status" data-range-delete-dirty>Choose range</span>
    <div class="ip-drawer-footer-actions">
      <button class="btn btn-secondary" type="button" data-range-delete-cancel>Cancel</button>
      <button class="btn btn-danger" type="submit" form="range-delete-form" data-range-delete-submit disabled>Delete permanently</button>
    </div>
  </div>
</aside>

<script src="/static/js/drawer.js" defer></script>
<script src="/static/js/ranges.js" defer></script>
{% endblock %}
