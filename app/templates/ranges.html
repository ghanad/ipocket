{% extends "base.html" %}

{% block content %}
<section class="page-header">
  <div>
    <h1>IP Ranges</h1>
    <p class="page-subtitle">Define CIDR ranges and review utilization across active IP assets.</p>
  </div>
  <div class="page-header-actions">
    <button class="btn btn-primary" type="button" data-range-add>New Range</button>
  </div>
</section>

<section class="card table-card">
  <div class="card-header card-header-padded">
    <div>
      <h2>Subnet Utilization</h2>
      <p class="subtitle">Click used or free to review addresses within each range.</p>
    </div>
  </div>
  <div class="table-wrapper">
    <table class="table">
      <thead>
        <tr>
          <th>Name</th>
          <th>CIDR</th>
          <th>Total usable</th>
          <th>Used</th>
          <th>Free</th>
          <th>Utilization</th>
        </tr>
      </thead>
      <tbody>
        {% for row in utilization %}
        <tr>
          <td>{{ row.name }}</td>
          <td>{{ row.cidr }}</td>
          <td>{{ row.total_usable }}</td>
          <td><a class="link" href="/ui/ranges/{{ row.id }}/addresses#used">{{ row.used }}</a></td>
          <td><a class="link" href="/ui/ranges/{{ row.id }}/addresses#free">{{ row.free }}</a></td>
          <td>{{ "%.1f"|format(row.utilization_percent) }}%</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6" class="empty-state">No ranges yet. Add ranges to see utilization.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<section class="card">
  <header class="card-header">
    <h2>Saved ranges</h2>
  </header>
  <div class="table-wrapper">
    <table class="table">
      <thead>
        <tr>
          <th>Name</th>
          <th>CIDR</th>
          <th>Notes</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for ip_range in ranges %}
        <tr>
          <td>{{ ip_range.name }}</td>
          <td>{{ ip_range.cidr }}</td>
          <td>{{ ip_range.notes or "‚Äî" }}</td>
          <td>{{ ip_range.created_at }}</td>
          <td class="asset-actions-cell">
            <div class="row-actions-menu" data-row-actions>
              <button
                class="row-actions-trigger"
                type="button"
                aria-label="Open actions for {{ ip_range.name }}"
                aria-expanded="false"
                aria-haspopup="true"
                aria-controls="row-actions-range-{{ ip_range.id }}"
                data-row-actions-toggle
              >
                <span class="row-actions-icon" aria-hidden="true">‚ãÆ</span>
              </button>
              <div
                class="row-actions-panel"
                id="row-actions-range-{{ ip_range.id }}"
                role="menu"
                aria-label="Actions for {{ ip_range.name }}"
                data-row-actions-panel
                hidden
              >
                <a class="row-action-item" role="menuitem" href="/ui/ranges/{{ ip_range.id }}/edit">
                  <span aria-hidden="true">‚úèÔ∏è</span>
                  <span>Edit</span>
                </a>
                <a class="row-action-item row-action-item-danger" role="menuitem" href="/ui/ranges/{{ ip_range.id }}/delete">
                  <span aria-hidden="true">üóëÔ∏è</span>
                  <span>Delete</span>
                </a>
              </div>
            </div>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="5" class="empty-state">No ranges saved yet.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
<script>
  (() => {
    const GLOBAL_FLAG = '__ipocket_range_row_actions_bound__';
    const POSITION_MARGIN = 12;

    const positionMenuPanel = (toggle, panel) => {
      const triggerRect = toggle.getBoundingClientRect();
      panel.style.top = '0px';
      panel.style.left = '0px';
      panel.style.bottom = 'auto';
      panel.style.visibility = 'hidden';
      panel.hidden = false;

      const panelRect = panel.getBoundingClientRect();
      let top = triggerRect.bottom + 6;
      let left = triggerRect.right - panelRect.width;

      if (left < POSITION_MARGIN) {
        left = POSITION_MARGIN;
      }

      if (left + panelRect.width > window.innerWidth - POSITION_MARGIN) {
        left = Math.max(POSITION_MARGIN, window.innerWidth - panelRect.width - POSITION_MARGIN);
      }

      if (top + panelRect.height > window.innerHeight - POSITION_MARGIN) {
        top = triggerRect.top - panelRect.height - 6;
      }

      if (top < POSITION_MARGIN) {
        top = POSITION_MARGIN;
      }

      panel.style.top = `${top}px`;
      panel.style.left = `${left}px`;
      panel.style.visibility = 'visible';
    };

    const closeAllMenus = () => {
      const actionMenus = document.querySelectorAll('[data-row-actions]');
      actionMenus.forEach((menu) => {
        const toggle = menu.querySelector('[data-row-actions-toggle]');
        const panel = menu.querySelector('[data-row-actions-panel]');
        if (toggle && panel) {
          toggle.setAttribute('aria-expanded', 'false');
          panel.hidden = true;
          panel.style.visibility = '';
          menu.classList.remove('is-open');
        }
      });
    };

    const bindRowActions = (root = document) => {
      const actionMenus = root.querySelectorAll('[data-row-actions]');
      actionMenus.forEach((menu) => {
        if (menu.dataset.rowActionsBound) {
          return;
        }
        const toggle = menu.querySelector('[data-row-actions-toggle]');
        const panel = menu.querySelector('[data-row-actions-panel]');
        if (!toggle || !panel) {
          return;
        }
        menu.dataset.rowActionsBound = 'true';

        toggle.addEventListener('click', (event) => {
          event.stopPropagation();
          const isOpen = toggle.getAttribute('aria-expanded') === 'true';
          closeAllMenus();
          if (!isOpen) {
            toggle.setAttribute('aria-expanded', 'true');
            positionMenuPanel(toggle, panel);
            menu.classList.add('is-open');
          }
        });

        panel.addEventListener('click', (event) => {
          event.stopPropagation();
        });
      });
    };

    if (!window[GLOBAL_FLAG]) {
      window[GLOBAL_FLAG] = true;
      document.addEventListener('click', () => {
        closeAllMenus();
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          closeAllMenus();
        }
      });

      window.addEventListener(
        'scroll',
        () => {
          closeAllMenus();
        },
        true,
      );

      const tableWrapper = document.querySelector('.table-wrapper');
      if (tableWrapper) {
        tableWrapper.addEventListener('scroll', () => {
          closeAllMenus();
        });
      }

      window.addEventListener('resize', () => {
        closeAllMenus();
      });
    }

    bindRowActions();
  })();
</script>


<div class="ip-drawer-overlay" data-range-create-overlay aria-hidden="true"></div>
<aside class="ip-drawer" data-range-create-drawer data-range-open="{{ 'true' if errors else 'false' }}" role="dialog" aria-modal="true" aria-label="Add IP range">
  <div class="ip-drawer-header">
    <div class="ip-drawer-header-row">
      <div>
        <h2 class="ip-drawer-title">Add IP Range</h2>
        <p class="ip-drawer-subtitle">Use CIDR notation to group ranges for reporting.</p>
      </div>
      <button class="ip-drawer-close" type="button" aria-label="Close drawer" data-range-create-close>‚úï</button>
    </div>
  </div>
  <div class="ip-drawer-body">
    {% if errors %}
    <div class="alert alert-error">
      <ul>
        {% for error in errors %}
        <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
    <form class="ip-drawer-form" method="post" action="/ui/ranges" data-range-create-form id="range-create-form">
      <section class="ip-drawer-section">
        <h3>Range details</h3>
        <label class="field">
          <span>Name</span>
          <input class="input" type="text" name="name" value="{{ form_state.name }}" data-range-input="name" required />
        </label>
        <label class="field">
          <span>CIDR</span>
          <input class="input" type="text" name="cidr" value="{{ form_state.cidr }}" placeholder="192.168.10.0/24" data-range-input="cidr" required />
        </label>
        <label class="field">
          <span>Notes</span>
          <textarea class="textarea" name="notes" rows="3" data-range-input="notes">{{ form_state.notes }}</textarea>
        </label>
      </section>
    </form>
  </div>
  <div class="ip-drawer-footer">
    <span class="ip-drawer-footer-status" data-range-create-dirty>Enter details</span>
    <div class="ip-drawer-footer-actions">
      <button class="btn btn-secondary" type="button" data-range-create-cancel>Cancel</button>
      <button class="btn btn-primary" type="submit" form="range-create-form" data-range-create-save disabled>Save range</button>
    </div>
  </div>
</aside>

<script src="/static/js/drawer.js" defer></script>
<script src="/static/js/ranges.js" defer></script>
{% endblock %}
